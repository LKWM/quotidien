<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CorÃ©en - Pratique Orale</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Nanum+Gothic:wght@400;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', 'Nanum Gothic', sans-serif;
            overflow: hidden; /* Prevent scrolling */
        }
        .course-container {
            width: 100%;
            max-width: 1000px;
        }
        .page {
            display: none;
            animation: fadeIn 0.5s ease-in-out;
        }
        .page.active {
            display: flex;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .quiz-option input:checked + label {
            background-color: #38bdf8;
            color: white;
            border-color: #0284c7;
        }
        .feedback-message {
            min-height: 2.5rem;
            font-weight: bold;
            margin-top: 1rem;
        }
        .mic-btn {
            transition: all 0.2s ease-in-out;
        }
        .mic-btn.recording {
            transform: scale(1.1);
            background-color: #ef4444; /* red-500 */
            box-shadow: 0 0 0 4px rgba(239, 68, 68, 0.4);
        }
        .mic-btn.loading {
            background-color: #6b7280; /* gray-500 */
            cursor: not-allowed;
            animation: pulse 1.5s infinite ease-in-out;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        .nav-container {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 1rem; /* p-4 */
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem; /* gap-4 */
        }
        @media (min-width: 640px) { /* sm: */
            .nav-container {
                padding: 1.5rem; /* sm:p-6 */
            }
        }
        @media (min-width: 1024px) { /* lg: */
            .nav-container {
                padding: 2rem; /* lg:p-8 */
            }
        }
    </style>
</head>
<body class="bg-slate-100 flex items-center justify-center min-h-screen h-screen p-2 sm:p-4">

    <div id="course-container" class="course-container bg-white rounded-2xl shadow-2xl flex flex-col p-4 sm:p-6 lg:p-8 relative overflow-hidden h-full">

        <!-- Audio elements -->
        <audio id="audio-annyeonghaseyo" src="https://static.wixstatic.com/mp3/699687_eecd04cdedb149b383bf501e72cbae2a.mp3" preload="auto"></audio>
        <audio id="audio-annyeonghi-gaseyo" src="https://static.wixstatic.com/mp3/699687_450c2b7baf664c4a8d3fc1423de8a5e7.mp3" preload="auto"></audio>
        <audio id="audio-gamsahamnida" src="https://static.wixstatic.com/mp3/699687_cbf26bae6c624aeabbe85140522122c7.mp3" preload="auto"></audio>
        <audio id="audio-joesonghamnida" src="https://static.wixstatic.com/mp3/699687_ff89caa097ee4b78a44f9fe2cb4245cd.mp3" preload="auto"></audio>
        <audio id="audio-annyeonghi-gyeseyo" src="https://static.wixstatic.com/mp3/699687_5e79d505dcae46adb3887b03d5a28905.mp3" preload="auto"></audio>
        
        <!-- Page content -->
        <div id="page-content" class="flex-grow flex flex-col justify-center items-center text-center overflow-auto pb-16 sm:pb-20">

            <!-- Page 0: Title -->
            <div id="page-0" class="page w-full h-full flex-col justify-center items-center">
                <h1 class="text-4xl sm:text-5xl lg:text-6xl font-extrabold text-slate-800">Pratique Orale</h1>
                <p class="text-lg sm:text-xl lg:text-2xl text-slate-600 mt-2 sm:mt-4 leading-relaxed">Testez votre prononciation et votre comprÃ©hension.</p>
            </div>

            <!-- Speech Recognition Pages (1-5) -->
            <div id="page-1" class="page w-full h-full flex-col justify-center items-center speech-quiz-page" data-quiz-index="0"></div>
            <div id="page-2" class="page w-full h-full flex-col justify-center items-center speech-quiz-page" data-quiz-index="1"></div>
            <div id="page-3" class="page w-full h-full flex-col justify-center items-center speech-quiz-page" data-quiz-index="2"></div>
            <div id="page-4" class="page w-full h-full flex-col justify-center items-center speech-quiz-page" data-quiz-index="3"></div>
            <div id="page-5" class="page w-full h-full flex-col justify-center items-center speech-quiz-page" data-quiz-index="4"></div>
            
            <!-- Multiple Choice Pages (6-10) -->
            <div id="page-6" class="page w-full h-full flex-col justify-center items-center mcq-quiz-page" data-quiz-index="5"></div>
            <div id="page-7" class="page w-full h-full flex-col justify-center items-center mcq-quiz-page" data-quiz-index="6"></div>
            <div id="page-8" class="page w-full h-full flex-col justify-center items-center mcq-quiz-page" data-quiz-index="7"></div>
            <div id="page-9" class="page w-full h-full flex-col justify-center items-center mcq-quiz-page" data-quiz-index="8"></div>
            <div id="page-10" class="page w-full h-full flex-col justify-center items-center mcq-quiz-page" data-quiz-index="9"></div>

            <!-- Speech Recognition Pages (11-15) -->
            <div id="page-11" class="page w-full h-full flex-col justify-center items-center speech-quiz-page" data-quiz-index="10"></div>
            <div id="page-12" class="page w-full h-full flex-col justify-center items-center speech-quiz-page" data-quiz-index="11"></div>
            <div id="page-13" class="page w-full h-full flex-col justify-center items-center speech-quiz-page" data-quiz-index="12"></div>
            <div id="page-14" class="page w-full h-full flex-col justify-center items-center speech-quiz-page" data-quiz-index="13"></div>
            <div id="page-15" class="page w-full h-full flex-col justify-center items-center speech-quiz-page" data-quiz-index="14"></div>
            
            <!-- Page 16: Final Score -->
            <div id="page-16" class="page w-full h-full flex-col justify-center items-center">
                <h2 class="text-3xl sm:text-4xl lg:text-5xl font-bold text-slate-800">Score Final</h2>
                <p id="final-score" class="text-5xl sm:text-6xl lg:text-7xl font-extrabold text-sky-500 my-4 sm:my-6">0 / 30</p>
                <p id="evaluation-message" class="text-base sm:text-xl lg:text-2xl text-slate-600 max-w-xl leading-relaxed"></p>
            </div>
        </div>

        <!-- Navigation -->
        <div class="nav-container">
            <div class="justify-self-start">
                <button id="prev-btn" class="bg-slate-200 text-slate-600 font-bold py-1.5 px-3 text-sm sm:py-2 sm:px-5 sm:text-base rounded-lg hover:bg-slate-300 transition-colors">PrÃ©cÃ©dent</button>
            </div>
            
            <div class="flex-grow sm:flex-grow-0 sm:w-1/2 h-2 bg-slate-200 rounded-full overflow-hidden mx-2">
                <div id="progress-indicator" class="h-full bg-sky-500 transition-all duration-300"></div>
            </div>
            
            <div class="justify-self-end flex gap-2">
                <button id="retry-btn" class="hidden bg-amber-500 text-white font-bold py-1.5 px-3 text-sm sm:py-2 sm:px-5 sm:text-base rounded-lg hover:bg-amber-600 transition-colors">RÃ©essayer</button>
                <button id="passer-btn" class="hidden bg-amber-500 text-white font-bold py-1.5 px-3 text-sm sm:py-2 sm:px-5 sm:text-base rounded-lg hover:bg-amber-600 transition-colors">Passer</button>
                <button id="next-btn" class="bg-sky-500 text-white font-bold py-1.5 px-3 text-sm sm:py-2 sm:px-5 sm:text-base rounded-lg hover:bg-sky-600 transition-colors">Suivant</button>
            </div>
        </div>
    </div>

    <script>
    // --- Global Audio Player ---
    function playAudio(id) {
        const audio = document.getElementById(`audio-${id}`);
        if (audio) {
            audio.currentTime = 0;
            audio.play().catch(e => console.error("Audio play failed:", e));
        }
    };

    document.addEventListener('DOMContentLoaded', () => {
        // --- API & Setup ---
        // [!!] ë‹˜ì´ Base 44ì—ì„œ ìƒì„±í•œ ë°±ì—”ë“œ í•¨ìˆ˜ì˜ ì´ë¦„ì„ ì—¬ê¸°ì— ì •í™•íˆ ì…ë ¥í•˜ì„¸ìš”.
        // ì—ì´ì „íŠ¸ê°€ "naverClovaSpeech"ë¼ê³  í–ˆìœ¼ë¯€ë¡œ, ì´ ì´ë¦„ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
        const CLOVA_API_FUNCTION_URL = '/api/functions/naverClovaSpeech';

        const totalPages = 17; // 0-16
        let currentPageIndex = 0;
        let scores = Array(15).fill(null); // 15ê°œì˜ í€´ì¦ˆ (0-14)
        // [ìˆ˜ì •] 1, 2íšŒì°¨ ì‹œë„ë¥¼ ê¸°ë¡ (85ì  ì»·)
        let recognitionAttempts = {}; 
        let soundsReady = false;

        const pages = document.querySelectorAll('.page');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        const passerBtn = document.getElementById('passer-btn');
        const retryBtn = document.getElementById('retry-btn');
        const progressBar = document.getElementById('progress-indicator');
        
        let correctSound, wrongSound, pageTurnSound, finishSound;
        const initAudioSynth = async () => {
            if (soundsReady) return;
            try {
                await Tone.start();
                correctSound = new Tone.Synth({ oscillator: { type: 'sine' }, envelope: { attack: 0.01, decay: 0.2, sustain: 0.2, release: 0.2 } }).toDestination();
                wrongSound = new Tone.Synth({ oscillator: { type: 'triangle' }, envelope: { attack: 0.01, decay: 0.4, sustain: 0.1, release: 0.2 } }).toDestination();
                pageTurnSound = new Tone.Synth({ oscillator: { type: 'sine' }, envelope: { attack: 0.005, decay: 0.1, sustain: 0, release: 0.1 } }).toDestination();
                finishSound = new Tone.PolySynth(Tone.Synth, { envelope: { attack: 0.05, decay: 0.4, sustain: 0.3, release: 1 } }).toDestination();
                soundsReady = true;
                console.log('Audio context started.');
            } catch (e) {
                console.error("Audio context could not be started: ", e);
            }
        };
        document.body.addEventListener('click', initAudioSynth, { once: true });
        document.body.addEventListener('touchstart', initAudioSynth, { once: true });
        
        // --- MediaRecorder (Naver API) ---
        let mediaRecorder;
        let audioChunks = [];
        let isRecording = false;
        let recordingTimeout; // 10ì´ˆ íƒ€ì„ì•„ì›ƒ

        async function startRecording(quizIndex) {
            if (isRecording) return;
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                alert("Votre navigateur ne supporte pas l'enregistrement audio.");
                return;
            }

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                isRecording = true;
                audioChunks = [];
                
                let mimeType = 'audio/webm;codecs=opus';
                if (!MediaRecorder.isTypeSupported(mimeType)) {
                    mimeType = 'audio/webm';
                    if (!MediaRecorder.isTypeSupported(mimeType)) {
                        mimeType = '';
                    }
                }
                
                mediaRecorder = new MediaRecorder(stream, { mimeType: mimeType }); 
                
                mediaRecorder.ondataavailable = event => {
                    audioChunks.push(event.data);
                };

                mediaRecorder.onstart = () => {
                    const micBtn = document.querySelector(`#mic-btn-${quizIndex}`);
                    if(micBtn) micBtn.classList.add('recording');
                    const transcriptEl = document.querySelector(`#transcript-${quizIndex}`);
                    if(transcriptEl) transcriptEl.textContent = "J'Ã©coute...";

                    // 10ì´ˆ ë…¹ìŒ ì œí•œ
                    clearTimeout(recordingTimeout);
                    recordingTimeout = setTimeout(() => {
                        if (isRecording) {
                            stopRecording(quizIndex);
                        }
                    }, 10000); // 10ì´ˆ
                };

                mediaRecorder.onstop = () => {
                    isRecording = false;
                    clearTimeout(recordingTimeout);
                    const micBtn = document.querySelector(`#mic-btn-${quizIndex}`);
                    if(micBtn) {
                        micBtn.classList.remove('recording');
                        micBtn.classList.add('loading');
                    }
                    const transcriptEl = document.querySelector(`#transcript-${quizIndex}`);
                    if(transcriptEl) transcriptEl.textContent = "Ã‰valuation en cours...";

                    const audioBlob = new Blob(audioChunks, { type: mediaRecorder.mimeType });
                    const reader = new FileReader();
                    reader.readAsDataURL(audioBlob);
                    reader.onloadend = () => {
                        const base64Audio = reader.result;
                        handlePronunciationEvaluation(quizIndex, base64Audio);
                    };
                    
                    stream.getTracks().forEach(track => track.stop());
                };

                mediaRecorder.start();
                
            } catch (err) {
                console.error("Error starting recording:", err);
                if (err.name === "NotAllowedError" || err.name === "PermissionDeniedError") {
                    alert("Impossible d'accÃ©der au microphone. Veuillez autoriser l'accÃ¨s.");
                } else {
                    alert(`Erreur microphone: ${err.name}. Veuillez rÃ©essayer.`);
                }
            }
        }

        function stopRecording(quizIndex) {
            clearTimeout(recordingTimeout);
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
            }
        }

        // í…ìŠ¤íŠ¸ ì •ê·œí™” í•¨ìˆ˜ (ë¹„êµìš©)
        function normalizeText(text) {
            if (typeof text !== 'string') return '';
            // ë„ì–´ì“°ê¸°, êµ¬ë‘ì (.,!?) ì œê±°
            return text.trim().replace(/[.,!?'\s]/g, '');
        }
        
        // --- Naver API í˜¸ì¶œ ë° ìƒˆ ì ìˆ˜ ë¡œì§ ---
        async function handlePronunciationEvaluation(quizIndex, audioBase64) {
            const quiz = quizzes[quizIndex];
            const page = document.querySelector(`#page-${currentPageIndex}`);
            const feedbackEl = page.querySelector('.feedback-message');
            const transcriptEl = page.querySelector(`#transcript-${quizIndex}`);
            const micBtn = page.querySelector(`#mic-btn-${quizIndex}`);
            const attemptsEl = page.querySelector(`#attempts-${quizIndex}`);

            if (recognitionAttempts[quizIndex] === undefined) recognitionAttempts[quizIndex] = 0;
            recognitionAttempts[quizIndex]++;
            const isFirstAttempt = recognitionAttempts[quizIndex] === 1;
            
            try {
                const response = await fetch(CLOVA_API_FUNCTION_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        audioBase64: audioBase64,
                        languageCode: "Kor", // ë„¤ì´ë²„ ë¬¸ì„œ ê¸°ì¤€ "Kor"
                        referenceText: quiz.answer
                    })
                });
    
                if (!response.ok) {
                    let errorDetails = "Erreur inconnue";
                    try {
                        const errorResult = await response.json();
                        errorDetails = errorResult.error || JSON.stringify(errorResult);
                    } catch (e) {
                        errorDetails = await response.text();
                    }
                    throw new Error(`Erreur du backend (${response.status}): ${errorDetails}`);
                }
    
                // [ìˆ˜ì •] ë°±ì—”ë“œê°€ ë°˜í™˜í•˜ëŠ” raw ë°ì´í„°ë¥¼ íŒŒì‹±í•©ë‹ˆë‹¤.
                // ì—ì´ì „íŠ¸ê°€ ë°˜í™˜í•œë‹¤ê³  í•œ: { success: true, text: "...", assessment: {...}, raw: {...} }
                // Naver ë¬¸ì„œ(12.40.51 AM.jpg)ì—ëŠ” `assessment_score`ê°€ ë£¨íŠ¸ì— ìˆìŠµë‹ˆë‹¤.
                // ì—ì´ì „íŠ¸ì˜ `naverClovaSpeech.js`ê°€ Naverì˜ `sttResult`ë¥¼ `raw` ê°ì²´ì— ë‹´ì•„ ë°˜í™˜í•œë‹¤ê³  ê°€ì •í•©ë‹ˆë‹¤.
                const result = await response.json(); 
                
                // [ìˆ˜ì •] ì—ì´ì „íŠ¸ê°€ ë°˜í™˜í•œë‹¤ëŠ” `result.raw` ê°ì²´ì—ì„œ ì ìˆ˜ì™€ í…ìŠ¤íŠ¸ë¥¼ ì¶”ì¶œ
                const sttResult = result.raw || result; // ë°±ì—”ë“œê°€ rawë¥¼ ì œê³µ ì•ˆí•˜ë©´ result ìì²´ë¥¼ ì‚¬ìš©
                
                const transcribedText = sttResult.text || '';
                const score = sttResult.assessment_score || 0; // (0-100)

                // 2. ì¸ì‹ëœ í…ìŠ¤íŠ¸ í‘œì‹œ
                if (transcriptEl) transcriptEl.textContent = `"${transcribedText || '...'}"`;

                // 3. [ì‹ ê·œ] ì •ë‹µ í™•ì¸: (a) í…ìŠ¤íŠ¸ ì¼ì¹˜ (b) ì ìˆ˜ 85ì  ì´ìƒ
                const normalizedTranscribed = normalizeText(transcribedText);
                const normalizedReference = normalizeText(quiz.answer);
                
                const isTextMatch = (normalizedTranscribed === normalizedReference);
                const isScorePass = score >= 85;
                
                // í…ìŠ¤íŠ¸ê°€ ì¼ì¹˜í•˜ê³ , ì ìˆ˜ê°€ 85ì  ì´ìƒì´ì–´ì•¼ í†µê³¼
                const isCorrect = isTextMatch && isScorePass; 
                // "ì•„ì˜ˆ ë‹¤ë¥¸ ê¸€ìë¡œ ì¸ì‹ëœ ê²½ìš°" -> isTextMatchê°€ falseì¸ ê²½ìš°

                let earnedPoints = 0;

                // 4. [ì‹ ê·œ] ì ìˆ˜ ë° UI ë¡œì§ (85ì  ê¸°ì¤€)
                if (isCorrect) {
                    earnedPoints = isFirstAttempt ? 2 : 1; // 1ì°¨ 2ì , 2ì°¨ 1ì 
                    scores[quizIndex] = earnedPoints;
                    correctSound?.triggerAttackRelease('C5', '0.2s');
                    if(micBtn) micBtn.disabled = true;
                    passerBtn.classList.add('hidden'); 
                    retryBtn.classList.add('hidden');
                    if(feedbackEl) feedbackEl.textContent = ""; // [ìˆ˜ì •] í”¼ë“œë°± ì¤‘ë³µ ì œê±°

                } else {
                    // 1ì°¨ ì‹œë„ ì‹¤íŒ¨ (ì¬ì‹œë„ ê¸°íšŒ)
                    if (isFirstAttempt) {
                        scores[quizIndex] = null; // ì•„ì§ ì ìˆ˜ ì—†ìŒ (ì¬ì‹œë„ ê°€ëŠ¥)
                        wrongSound?.triggerAttackRelease('A#2', '0.2s');
                        if(attemptsEl) attemptsEl.textContent = "Tentatives restantes : 1";
                        if(feedbackEl) {
                             // [ìˆ˜ì •] í”¼ë“œë°± ì¤‘ë³µ ì œê±°
                             feedbackEl.textContent = ""; 
                             feedbackEl.className = 'feedback-message text-base sm:text-xl text-red-500';
                        }
                    } else {
                    // 2ì°¨ ì‹œë„ ì‹¤íŒ¨ (0ì  ì²˜ë¦¬)
                        scores[quizIndex] = 0;
                        wrongSound?.triggerAttackRelease('A#2', '0.2s');
                        if(feedbackEl) {
                             // [ìˆ˜ì •] 2íšŒ ì‹¤íŒ¨ ì‹œì—ë§Œ ì •ë‹µ í‘œì‹œ
                             feedbackEl.textContent = `La bonne rÃ©ponse est : "${quiz.answer}"`;
                             feedbackEl.className = 'feedback-message text-base sm:text-xl text-red-500';
                        }
                        if(micBtn) micBtn.disabled = true;
                        passerBtn.classList.remove('hidden'); 
                        retryBtn.classList.add('hidden');
                    }
                }

                // 5. [ìš”ì²­ì‚¬í•­] ì ìˆ˜ì™€ í”¼ë“œë°±ì„ ë¶€ëª¨(Parent) í˜ì´ì§€ë¡œ ì „ì†¡
                window.parent.postMessage({
                    type: 'pronunciation_result',
                    quizId: quizIndex,
                    naverScore: score, // Naver ì›ì ìˆ˜ (0-100)
                    pointsAwarded: earnedPoints, // íšë“ ì ìˆ˜ (0, 1, 2)
                    transcribedText: transcribedText,
                    referenceText: quiz.answer,
                    isCorrect: isCorrect,
                    attempt: recognitionAttempts[quizIndex],
                    // [ìˆ˜ì •] ì—ì´ì „íŠ¸ì˜ ìµœì‹  ì •ë³´ë¥¼ ë°˜ì˜í•˜ì—¬ Naver ì›ë³¸ assessment ê°ì²´(ë˜ëŠ” ì ìˆ˜) ì „ì†¡
                    assessment: sttResult.assessment || { pronunciation: score } // Naverê°€ assessment ê°ì²´ë¥¼ ì•ˆì£¼ë©´ ì ìˆ˜ë¼ë„ ë³´ëƒ„
                }, '*');

            } catch (error) {
                console.error("Erreur lors de l'Ã©valuation:", error);
                if(feedbackEl) {
                    feedbackEl.textContent = "Erreur de connexion. Veuillez rÃ©essayer.";
                    feedbackEl.className = 'feedback-message text-base sm:text-xl text-red-500';
                }
                if (recognitionAttempts[quizIndex] > 0) recognitionAttempts[quizIndex]--; 
            } finally {
                // 6. UI ì—…ë°ì´íŠ¸
                if(attemptsEl) attemptsEl.textContent = `Tentatives restantes : ${Math.max(0, 2 - recognitionAttempts[quizIndex])}`;
                if(micBtn) micBtn.classList.remove('loading');
                updateNavigation(currentPageIndex);
            }
        }
        
        // --- Quiz Data ---
        const quizzes = [
            // Speech Recognition 1-5
            { type: 'speech', answer: 'ì•ˆë…•í•˜ì„¸ìš”', fr: 'Bonjour', audio: 'annyeonghaseyo' },
            { type: 'speech', answer: 'ì•ˆë…•íˆ ê°€ì„¸ìš”', fr: 'Partez bien', audio: 'annyeonghi-gaseyo' },
            { type: 'speech', answer: 'ê°ì‚¬í•©ë‹ˆë‹¤', fr: 'Merci', audio: 'gamsahamnida' },
            { type: 'speech', answer: 'ì£„ì†¡í•©ë‹ˆë‹¤', fr: 'DÃ©solÃ©', audio: 'joesonghamnida' },
            { type: 'speech', answer: 'ì•ˆë…•íˆ ê³„ì„¸ìš”', fr: 'Restez bien', audio: 'annyeonghi-gyeseyo' },
            // MCQ 6-10
            { type: 'mcq', questionAudio: 'annyeonghaseyo', answer: 'Bonjour', options: ['Bonjour', 'Au revoir', 'Merci', 'DÃ©solÃ©'] },
            { type: 'mcq', questionAudio: 'annyeonghi-gaseyo', answer: 'Partez bien', options: ['Bonjour', 'Partez bien', 'DÃ©solÃ©', 'Restez bien'] },
            { type: 'mcq', questionAudio: 'gamsahamnida', answer: 'Merci', options: ['DÃ©solÃ©', 'Bonjour', 'Merci', 'Au revoir'] },
            { type: 'mcq', questionAudio: 'joesonghamnida', answer: 'DÃ©solÃ©', options: ['Bonjour', 'Partez bien', 'DÃ©solÃ©', 'Restez bien'] },
            { type: 'mcq', questionAudio: 'annyeonghi-gyeseyo', answer: 'Restez bien', options: ['Restez bien', 'Partez bien', 'Bonjour', 'Merci'] },
            // Speech Recognition 11-15
            { type: 'speech-fr', answer: 'ì•ˆë…•í•˜ì„¸ìš”', fr: 'Bonjour' },
            { type: 'speech-fr', answer: 'ê°ì‚¬í•©ë‹ˆë‹¤', fr: 'Merci' },
            { type: 'speech-fr', answer: 'ì£„ì†¡í•©ë‹ˆë‹¤', fr: 'DÃ©solÃ©' },
            { type: 'speech-fr', answer: 'ì•ˆë…•íˆ ê³„ì„¸ìš”', fr: 'Restez bien' },
            { type: 'speech-fr', answer: 'ì•ˆë…•íˆ ê°€ì„¸ìš”', fr: 'Partez bien' },
        ];

        // --- Quiz Generation ---
        function generateQuizPage(quizIndex) {
            const quiz = quizzes[quizIndex];
            const page = document.querySelector(`.page[data-quiz-index="${quizIndex}"]`);
            if (!page) return;

            let content = '';
            if (quiz.type === 'speech') {
                content = `
                    <button onclick="playAudio('${quiz.audio}')" class="text-3xl sm:text-4xl lg:text-5xl font-extrabold text-slate-800 bg-sky-100 px-4 py-2 sm:px-6 sm:py-4 rounded-2xl hover:bg-sky-200 transition-colors">${quiz.answer}</button>
                    <div class="text-xl sm:text-2xl lg:text-3xl font-semibold text-sky-600 mt-2 sm:mt-4 mb-4 sm:mb-6">${quiz.fr}</div>
                    <p class="text-base sm:text-lg lg:text-xl text-slate-600 mb-2 leading-relaxed">RÃ©pÃ©tez la phrase.</p>
                `;
            } else if (quiz.type === 'speech-fr') {
                content = `
                    <div class="text-xl sm:text-2xl lg:text-3xl font-semibold text-slate-700 mb-4 sm:mb-6">" ${quiz.fr} "</div>
                    <p class="text-base sm:text-lg lg:text-xl text-slate-600 mb-2 sm:mb-4 leading-relaxed">Dites-le en corÃ©en.</p>
                `;
            } else if (quiz.type === 'mcq') {
                const optionsHTML = quiz.options.map((opt, i) => `
                    <div class="quiz-option">
                        <input type="radio" name="q${quizIndex}" value="${opt}" id="q${quizIndex}o${i}" class="hidden">
                        <label for="q${quizIndex}o${i}" class="block cursor-pointer py-2 px-3 sm:py-3 sm:px-4 border-2 border-slate-200 rounded-lg text-base sm:text-lg lg:text-xl font-bold">${opt}</label>
                    </div>
                `).join('');
                content = `
                    <h2 class="text-lg sm:text-xl lg:text-2xl font-semibold text-slate-800 mb-2 leading-relaxed">Que signifie cette phrase ?</h2>
                    <button onclick="playAudio('${quiz.questionAudio}')" class="mb-2 text-4xl sm:text-5xl hover:opacity-75 transition-opacity">
                        ğŸ”ˆ
                    </button>
                    <form id="quiz-form-${quizIndex}" class="w-full max-w-lg px-4">
                        <div class="space-y-2">${optionsHTML}</div>
                        <div class="feedback-message text-base sm:text-xl"></div>
                        <button type="submit" class="w-full mt-2 bg-sky-500 text-white font-bold py-2 px-4 sm:py-3 sm:px-5 text-sm sm:text-base rounded-lg hover:bg-sky-600 transition-colors">VÃ©rifier</button>
                    </form>
                `;
            }
            
            if (quiz.type.startsWith('speech')) {
                content += `
                    <button id="mic-btn-${quizIndex}" class="mic-btn my-2 sm:my-4 bg-sky-500 text-white rounded-full text-4xl sm:text-5xl flex justify-center items-center w-16 h-16 sm:w-20 sm:h-20 hover:bg-sky-600">
                        ğŸ™ï¸
                    </button>
                    <div id="transcript-${quizIndex}" class="text-base sm:text-xl lg:text-2xl text-slate-500 h-8"></div>
                    <div class="feedback-message text-base sm:text-xl h-8 sm:h-10"></div>
                    <!-- [ìˆ˜ì •] 2íšŒ ì‹œë„ë¡œ ë³€ê²½ -->
                    <div id="attempts-${quizIndex}" class="text-xs sm:text-sm text-slate-400 mt-2">Tentatives restantes : 2</div>
                `;
            }

            page.innerHTML = content;
        }
        
        quizzes.forEach((_, i) => generateQuizPage(i));

        // --- Page Management ---
        const showPage = (index) => {
            pages.forEach((page, i) => page.classList.toggle('active', i === index));
            updateNavigation(index);
            updateProgressBar(index);
            if (index === totalPages - 1) { // ë§ˆì§€ë§‰ í˜ì´ì§€ (16)
                calculateAndShowScore();
                // [ìš”ì²­ ì‚¬í•­] ë ˆìŠ¨ ì™„ë£Œ postMessage
                window.parent.postMessage({ type: 'lesson_complete' }, '*');
                console.log('Lesson complete message sent to parent.');
            }
        };

        const updateNavigation = (index) => {
            prevBtn.style.visibility = index > 0 ? 'visible' : 'hidden';
            nextBtn.style.visibility = index < totalPages - 1 ? 'visible' : 'hidden';
            passerBtn.classList.add('hidden');
            retryBtn.classList.add('hidden');
            
            const quizIndex = pages[index].dataset.quizIndex;
            if (quizIndex !== undefined) {
                const isAnswered = scores[quizIndex] !== null;
                nextBtn.classList.toggle('hidden', !isAnswered);

                const quiz = quizzes[quizIndex];
                
                // [ìˆ˜ì •] 2íšŒ ì‹œë„ ì‹¤íŒ¨ ì‹œ 'Passer' ë²„íŠ¼ í‘œì‹œ
                if (quiz.type.startsWith('speech') && recognitionAttempts[quizIndex] >= 2 && scores[quizIndex] === 0) {
                    passerBtn.classList.remove('hidden');
                    nextBtn.classList.add('hidden'); // 'Passer'ê°€ 'Next'ë¥¼ ëŒ€ì‹ í•¨
                }
                
                // MCQ ì˜¤ë‹µ ì‹œ 'Retry' ë²„íŠ¼ í‘œì‹œ
                if (quiz.type === 'mcq' && scores[quizIndex] === 0) {
                     retryBtn.classList.remove('hidden');
                }
            } else {
                nextBtn.classList.remove('hidden');
            }
        };

        const updateProgressBar = (index) => {
            progressBar.style.width = `${((index + 1) / totalPages) * 100}%`;
        };
        
        nextBtn.addEventListener('click', () => {
            if (currentPageIndex < totalPages - 1) {
                pageTurnSound?.triggerAttackRelease('A5', '0.05s');
                currentPageIndex++;
                showPage(currentPageIndex);
            }
        });

        prevBtn.addEventListener('click', () => {
            if (currentPageIndex > 0) {
                pageTurnSound?.triggerAttackRelease('G5', '0.05s');
                currentPageIndex--;
                showPage(currentPageIndex);
            }
        });

        passerBtn.addEventListener('click', () => {
             const quizIndex = pages[currentPageIndex].dataset.quizIndex;
             if (scores[quizIndex] === null) scores[quizIndex] = 0; // ì ìˆ˜ 0ì ìœ¼ë¡œ í™•ì •
             if (currentPageIndex < totalPages - 1) {
                  currentPageIndex++;
                  showPage(currentPageIndex);
             }
        });
        
        retryBtn.addEventListener('click', () => {
            // [ìˆ˜ì •] ì´ ë²„íŠ¼ì€ MCQ ì „ìš©ì„
            const quizIndex = parseInt(pages[currentPageIndex].dataset.quizIndex);
            const quiz = quizzes[quizIndex];
            
            if (quiz.type === 'mcq') {
                 scores[quizIndex] = null; // Reset score to unanswered
                 const form = document.querySelector(`#quiz-form-${quizIndex}`);
                 if (form) {
                     form.reset();
                     const radios = form.querySelectorAll('input[type="radio"]');
                     radios.forEach(r => r.disabled = false);
                     form.querySelector('.feedback-message').textContent = '';
                     form.querySelector('button[type=submit]').classList.remove('hidden');
                 }
            } 

            retryBtn.classList.add('hidden');
            passerBtn.classList.add('hidden');
            updateNavigation(currentPageIndex);
        });
        
        // --- Quiz Handlers ---
        
        // [ìˆ˜ì •] Speech Recognition (MediaRecorder)
        document.querySelectorAll('.speech-quiz-page').forEach(page => {
            const quizIndex = parseInt(page.dataset.quizIndex);
            const micBtn = page.querySelector(`#mic-btn-${quizIndex}`);
            
            if (micBtn) {
                micBtn.addEventListener('click', () => {
                    if (micBtn.disabled || micBtn.classList.contains('loading')) return;

                    if (!recognitionAttempts[quizIndex]) recognitionAttempts[quizIndex] = 0;
                    // [ìˆ˜ì •] 2íšŒ ì‹œë„ ì œí•œ
                    if (recognitionAttempts[quizIndex] >= 2 && scores[quizIndex] === null) return; 
                    
                    if (isRecording) {
                        stopRecording(quizIndex);
                    } else {
                        initAudioSynth(); // ì˜¤ë””ì˜¤ ì»¨í…ìŠ¤íŠ¸ í™œì„±í™” (í´ë¦­ ì‹œ)
                        startRecording(quizIndex);
                    }
                });
            }
        });

        // [ìˆ˜ì •] Multiple Choice
        document.querySelectorAll('.mcq-quiz-page').forEach(page => {
            const quizIndex = parseInt(page.dataset.quizIndex);
            const form = page.querySelector(`#quiz-form-${quizIndex}`);
            if(form) {
                form.addEventListener('submit', (e) => {
                    e.preventDefault();
                    initAudioSynth(); // ì‚¬ìš´ë“œ ì´ˆê¸°í™”
                    const formData = new FormData(form);
                    const userAnswer = formData.get(`q${quizIndex}`);
                    const feedbackEl = form.querySelector('.feedback-message');
                    
                    if (!userAnswer) {
                        feedbackEl.textContent = "Veuillez sÃ©lectionner une rÃ©ponse.";
                        feedbackEl.className = 'feedback-message text-base sm:text-xl text-yellow-500';
                        return;
                    }
                    
                    form.querySelectorAll('input[type="radio"]').forEach(r => r.disabled = true);
                    form.querySelector('button[type=submit]').classList.add('hidden');
                    
                    if (userAnswer === quizzes[quizIndex].answer) {
                        scores[quizIndex] = 2; // MCQëŠ” ì •ë‹µ ì‹œ 2ì 
                        feedbackEl.textContent = 'Correct !';
                        feedbackEl.className = 'feedback-message text-base sm:text-xl text-green-500';
                        correctSound?.triggerAttackRelease('C5', '0.2s');
                    } else {
                        scores[quizIndex] = 0;
                        feedbackEl.textContent = 'Incorrect.';
                        feedbackEl.className = 'feedback-message text-base sm:text-xl text-red-500';
                        wrongSound?.triggerAttackRelease('A#2', '0.2s');
                        retryBtn.classList.remove('hidden');
                    }
                    updateNavigation(currentPageIndex);
                });
            }
        });
        
        // --- Score Calculation ---
        function calculateAndShowScore() {
            // [ìˆ˜ì •] ìŠ¤í”¼ì¹˜ 10ë¬¸ì œ (ìµœëŒ€ 2ì ), MCQ 5ë¬¸ì œ (2ì ) = 20 + 10 = 30ì  ë§Œì 
            const totalScore = scores.reduce((sum, score) => sum + (score === null ? 0 : score), 0);
            const maxScore = 30;
            document.getElementById('final-score').textContent = `${totalScore} / ${maxScore}`;
            
            const messageEl = document.getElementById('evaluation-message');
            const percentage = (totalScore / maxScore) * 100;

            if (percentage >= 85) { // 25.5+
                messageEl.textContent = "TrÃ¨s bien ! Passez Ã  l'Ã©tape suivante et continuez Ã  apprendre le corÃ©en !";
            } else if (percentage >= 66) { // 19.8+
                messageEl.textContent = "Bien jouÃ©. Passez Ã  l'Ã©tape suivante et continuez Ã  apprendre le corÃ©en !";
            } else if (percentage >= 50) { // 15+
                messageEl.textContent = "Bien jouÃ©. AmÃ©liorez votre corÃ©en avec une pratique rÃ©guliÃ¨re !";
            } else if (percentage >= 33) { // 9.9+
                messageEl.textContent = "Bon travail. AmÃ©liorez votre corÃ©en avec une pratique rÃ©guliÃ¨re !";
            } else {
                messageEl.textContent = "Bon travail. Que diriez-vous de revoir les phrases 1 Ã  5 ?";
            }
        }

        // --- Initialisation ---
        showPage(currentPageIndex);
    });
    </script>
</body>
</html>
