import { createClientFromRequest } from 'npm:@base44/sdk@0.7.1';

// Base 44 ë°±ì—”ë“œ í•¨ìˆ˜ëŠ” Deno ì „ì—­ ê°ì²´ë¥¼ ì‚¬ìš©í•˜ë¯€ë¡œ importê°€ í•„ìš” ì—†ìŠµë‹ˆë‹¤.
// import { Deno } from "deno"; 

Deno.serve(async (req) => {
    try {
        const base44 = createClientFromRequest(req);

        // 1. ì‚¬ìš©ì ì¸ì¦
        const user = await base44.auth.me();
        if (!user) {
            return Response.json({ error: 'Non autorisÃ©' }, { status: 401 });
        }

        // 2. í”„ë¡ íŠ¸ì—”ë“œ(HTML)ì—ì„œ ë³´ë‚¸ íŒŒë¼ë¯¸í„° ì¶”ì¶œ
        // (í”„ë¡ íŠ¸ì—ì„œ "Kor"ë¥¼ ë³´ë‚´ë¯€ë¡œ languageCodeë„ ë°›ìŠµë‹ˆë‹¤)
        const { audioBase64, languageCode, referenceText } = await req.json();

        if (!audioBase64 || !languageCode || !referenceText) {
            return Response.json({ 
                error: 'ParamÃ¨tres manquants: audioBase64, languageCode et referenceText sont requis' 
            }, { status: 400 });
        }

        // 3. [ìˆ˜ì •] Base 44 Configuration íƒ­ì— ì €ì¥ëœ *í•˜ë‚˜*ì˜ í‚¤ë¥¼ ì½ì–´ì˜µë‹ˆë‹¤.
        const clovaApiKey = Deno.env.get("Naver_Clova_API_KEY");

        if (!clovaApiKey || !clovaApiKey.includes(':')) {
            return Response.json({ 
                error: "ClÃ© API Naver Clova (Naver_Clova_API_KEY) non configurÃ©e ou au mauvais format (doit Ãªtre CLIENT_ID:CLIENT_SECRET)" 
            }, { status: 500 });
        }

        // [ìˆ˜ì •] í•˜ë‚˜ì˜ í‚¤ë¥¼ ':' ê¸°ì¤€ìœ¼ë¡œ ë‘ ê°œë¡œ ë¶„ë¦¬í•©ë‹ˆë‹¤.
        const [clientId, clientSecret] = clovaApiKey.split(':');

        if (!clientId || !clientSecret) {
            return Response.json({ 
                error: "Format de clÃ© API non valide. Assurez-vous qu'il s'agit de CLIENT_ID:CLIENT_SECRET"
            }, { status: 500 });
        }


        // 4. [ìˆ˜ì •] API URL (https:// ì‚¬ìš©)
        const sttEndpoint = new URL("https://clovaspeech-gw.ncloud.com/recog/v1/stt");
        sttEndpoint.searchParams.append("lang", languageCode); // í”„ë¡ íŠ¸ì—ì„œ ë°›ì€ "Kor" ì‚¬ìš©
        sttEndpoint.searchParams.append("assessment", "true");
        sttEndpoint.searchParams.append("utterance", referenceText);

        // 5. [ìˆ˜ì •] Base64 ë°ì´í„°ì—ì„œ Data URI prefix ì œê±°
        const pureBase64 = audioBase64.split(',')[1] || audioBase64;
        if (!pureBase64) {
             return Response.json({ error: 'Format audioBase64 non valide' }, { status: 400 });
        }
        
        // [ìˆ˜ì •] atobë¥¼ ì‚¬ìš©í•œ ë°”ì´íŠ¸ ë°°ì—´ ë³€í™˜ (Deno.core ëŒ€ì‹ )
        // atob()ëŠ” Base64 ë¬¸ìì—´ì„ binary stringìœ¼ë¡œ ë””ì½”ë”©í•©ë‹ˆë‹¤.
        const binaryString = atob(pureBase64);
        // binary stringì„ Uint8Array(ë°”ì´íŠ¸ ë°°ì—´)ë¡œ ë³€í™˜í•©ë‹ˆë‹¤.
        const audioData = new Uint8Array(binaryString.length);
        for (let i = 0; i < binaryString.length; i++) {
          audioData[i] = binaryString.charCodeAt(i);
        }

        // 6. [ìˆ˜ì •] Naver API í˜¸ì¶œ (ì˜¬ë°”ë¥¸ í—¤ë” ì‚¬ìš©)
        const response = await fetch(sttEndpoint, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/octet-stream',
                'X-NCP-APIGW-API-KEY-ID': clientId,     // <-- ì˜¬ë°”ë¥¸ í—¤ë” 1
                'X-NCP-APIGW-API-KEY': clientSecret,  // <-- ì˜¬ë°”ë¥¸ í—¤ë” 2
            },
            body: audioData,
        });

        if (!response.ok) {
            const errorText = await response.text();
            console.error('Naver Clova API Error:', errorText);
            return Response.json({
                error: 'Erreur lors de la transcription audio',
                details: errorText,
            }, { status: 500 });
        }

        const result = await response.json();

        // 7. í”„ë¡ íŠ¸ì—”ë“œë¡œ Naverê°€ ì œê³µí•œ "ì‹¤ì œ ë°œìŒ ì ìˆ˜"ë¥¼ ë°˜í™˜
        // (í”„ë¡ íŠ¸ì—”ë“œ ì½”ë“œ(HTML)ê°€ ì´ ì ìˆ˜ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤)
        const transcribedText = result.text || '';
        const score = result.assessment_score || 0; // 1~100ì 

        // 8. ë°±ì—”ë“œì—ì„œ ìƒì„±í•œ í”¼ë“œë°± (í”„ë¡ íŠ¸ì—”ë“œë¡œ ì „ë‹¬ë¨)
        let feedback = '';
        if (score >= 90) {
            feedback = 'Excellente pronunciation ! ğŸ‰';
        } else if (score >= 70) {
            feedback = 'Bonne pronunciation !';
        } else if (score >= 50) {
            feedback = 'C\'est un bon dÃ©but. Essayez de prononcer plus clairement.';
        } else {
            feedback = 'Continuez Ã  pratiquer. Ã‰coutez attentivement et rÃ©essayez.';
        }

        return Response.json({
            score: score, // Naver ì›ì ìˆ˜ (0-100)
            transcribedText: transcribedText,
            feedback: feedback // ë°±ì—”ë“œ ìƒì„± í”¼ë“œë°±
        }, {
            status: 200,
            headers: { 'Content-Type': 'application/json' },
        });

    } catch (error) {
        console.error('Error in Naver Clova Speech function:', error);
        return Response.json({ 
            error: error.message || 'Erreur interne du serveur'
        }, { status: 500 });
    }
});
