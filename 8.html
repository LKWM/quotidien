<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Le cor√©en au quotidien - Le√ßon 8: Ce n'est pas grave</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Nanum+Gothic:wght@400;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', 'Nanum Gothic', sans-serif;
            overflow: hidden; /* Prevent scrolling on body */
        }
        /* Î∞òÏùëÌòï Ïª®ÌÖåÏù¥ÎÑà ÏÑ§Ï†ï */
        .course-container {
            width: 100%;
            max-width: 1000px;
        }
        .page {
            display: none;
            animation: fadeIn 0.5s ease-in-out;
        }
        .page.active {
            display: flex;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .interactive-card {
            transition: all 0.2s ease-in-out;
            cursor: pointer;
        }
        .interactive-card:hover {
            transform: scale(1.03);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        /* Î∞òÏùëÌòï Ïò§ÎîîÏò§ Î≤ÑÌäº */
        .audio-hint-btn {
            flex-shrink: 0;
            background-color: #dbeafe;
            color: #2563eb;
            border-radius: 9999px;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
        }
        @media (min-width: 640px) {
            .audio-hint-btn { width: 44px; height: 44px; }
        }
        .audio-hint-btn:hover { background-color: #bfdbfe; }
        
        .quiz-option input:checked + label {
            background-color: #38bdf8;
            color: white;
            border-color: #0284c7;
        }
        
        /* Î∞òÏùëÌòï ÌÇ§Î≥¥Îìú Ïä§ÌÉÄÏùº */
        .keyboard {
            display: grid;
            gap: 2px;
            padding: 4px;
            background-color: #e5e7eb;
            border-radius: 8px;
        }
        .keyboard-row {
            display: grid;
            grid-auto-flow: column;
            gap: 2px;
        }
        .key {
            font-family: 'Nanum Gothic', sans-serif;
            font-weight: 700;
            background-color: white;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            padding: 4px 6px;
            font-size: 0.875rem;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: background-color 0.1s;
        }
        @media (min-width: 640px) {
            .keyboard { gap: 4px; padding: 8px; }
            .keyboard-row { gap: 4px; }
            .key { padding: 8px 12px; font-size: 1rem; }
        }
        .key:hover { background-color: #f3f4f6; }
        .key:active { background-color: #d1d5db; }
        
        /* Î∞òÏùëÌòï ÌÄ¥Ï¶à Î∞ïÏä§ Î∞è Ïπ¥Îìú */
        .order-answer-box {
            min-height: 50px;
            border: 2px dashed #9ca3af;
            background-color: #f9fafb;
        }
        .order-option-card, .order-answer-card {
            font-weight: 700;
            border-radius: 0.5rem;
            background-color: white;
            border: 2px solid #e5e7eb;
        }
        .feedback-message {
            height: 1.5rem;
            font-weight: bold;
            margin-top: 0.5rem;
        }
        .quiz-input-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            width: 100%;
            max-width: 95%;
            background-color: #f3f4f6;
            padding: 0.5rem;
            border-radius: 0.75rem;
        }
        .quiz-input-wrapper {
            font-size: 1.5rem;
            line-height: 2rem;
            font-weight: 700;
            flex-grow: 1;
            text-align: center;
        }
        @media (min-width: 640px) {
            .quiz-input-wrapper { font-size: 2.25rem; line-height: 2.5rem; }
        }
        .quiz-input {
            color: #2563eb;
            border-bottom: 3px solid #3b82f6;
            min-height: 32px;
            display: inline-block;
        }
        .prefilled-text { color: #4b5563; }
        
        .btn-disabled,
        .btn-disabled:hover {
            background-color: #9ca3af;
            color: #e5e7eb;
            cursor: not-allowed;
            opacity: 0.7;
            border-color: #9ca3af;
        }
    </style>
</head>
<body class="bg-slate-100 flex items-center justify-center min-h-screen h-screen p-2 sm:p-4">

    <!-- Fluid container structure -->
    <div id="course-container" class="course-container bg-white rounded-2xl shadow-2xl flex flex-col p-4 sm:p-6 lg:p-8 relative overflow-hidden h-full">
        
        <!-- Audio elements (Lesson 8 Specific + Generic) -->
        <audio id="audio-gwaenchanayo" src="https://static.wixstatic.com/mp3/699687_8ad7694f20f3465599ea2e4c798bd886.mp3" preload="auto"></audio>
        <audio id="audio-gwaenchanayo-q" src="https://static.wixstatic.com/mp3/699687_f5b09fd4a4254cffa4dd3b3c614a2487.mp3" preload="auto"></audio>
        <audio id="audio-gwaenchan" src="https://static.wixstatic.com/mp3/699687_480ba3089e64456d9520fe80ad450eae.mp3" preload="auto"></audio>
        <audio id="audio-ayo" src="https://static.wixstatic.com/mp3/699687_5cbec44a1de840f0a8a6973ea9befbc4.mp3" preload="auto"></audio>
        <audio id="audio-gwaen" src="https://static.wixstatic.com/mp3/699687_4f92b09dc9634e0ca26d0c7a2acc286d.mp3" preload="auto"></audio>
        <audio id="audio-chan" src="https://static.wixstatic.com/mp3/699687_bcb764efec35460c923a750bdc8f9d5f.mp3" preload="auto"></audio>
        <audio id="audio-a" src="https://static.wixstatic.com/mp3/699687_d2068aa842e04f4c8667dc09b9ceaa0f.mp3" preload="auto"></audio>
        <audio id="audio-yo" src="https://static.wixstatic.com/mp3/699687_311e7d2a0a76423b8c58747cc5dcf4f6.mp3" preload="auto"></audio>
        
        <!-- Quiz/Review Audio -->
        <audio id="audio-annyeonghaseyo" src="https://static.wixstatic.com/mp3/699687_eecd04cdedb149b383bf501e72cbae2a.mp3" preload="auto"></audio>
        <audio id="audio-gamsahamnida" src="https://static.wixstatic.com/mp3/699687_cbf26bae6c624aeabbe85140522122c7.mp3" preload="auto"></audio>
        <audio id="audio-joesonghamnida" src="https://static.wixstatic.com/mp3/699687_ff89caa097ee4b78a44f9fe2cb4245cd.mp3" preload="auto"></audio>
        <audio id="audio-annyeonghi-gyeseyo" src="https://static.wixstatic.com/mp3/699687_5e79d505dcae46adb3887b03d5a28905.mp3" preload="auto"></audio>
        <audio id="audio-annyeonghi-gaseyo" src="https://static.wixstatic.com/mp3/699687_450c2b7baf664c4a8d3fc1423de8a5e7.mp3" preload="auto"></audio>
        <audio id="audio-eoseo-oseyo" src="https://static.wixstatic.com/mp3/699687_7ec4bd8864f64a46b9a2306548216591.mp3" preload="auto"></audio>
        
        <!-- Hint Mappings -->
        <audio id="audio-ce-nest-pas-grave" src="https://static.wixstatic.com/mp3/699687_8ad7694f20f3465599ea2e4c798bd886.mp3" preload="auto"></audio> 
        <audio id="audio-desole" src="https://static.wixstatic.com/mp3/699687_ff89caa097ee4b78a44f9fe2cb4245cd.mp3" preload="auto"></audio>
        <audio id="audio-bon-retour" src="https://static.wixstatic.com/mp3/699687_450c2b7baf664c4a8d3fc1423de8a5e7.mp3" preload="auto"></audio>
        <audio id="audio-merci" src="https://static.wixstatic.com/mp3/699687_cbf26bae6c624aeabbe85140522122c7.mp3" preload="auto"></audio>
        <audio id="audio-bienvenue" src="https://static.wixstatic.com/mp3/699687_7ec4bd8864f64a46b9a2306548216591.mp3" preload="auto"></audio>
        <audio id="audio-restez-bien" src="https://static.wixstatic.com/mp3/699687_5e79d505dcae46adb3887b03d5a28905.mp3" preload="auto"></audio>
        <audio id="audio-ca-va-question" src="https://static.wixstatic.com/mp3/699687_f5b09fd4a4254cffa4dd3b3c614a2487.mp3" preload="auto"></audio>
        <audio id="audio-desole-ca-va-question" src="https://static.wixstatic.com/mp3/699687_ff89caa097ee4b78a44f9fe2cb4245cd.mp3" preload="auto"></audio>
        <audio id="audio-merci-ce-nest-pas-grave" src="https://static.wixstatic.com/mp3/699687_cbf26bae6c624aeabbe85140522122c7.mp3" preload="auto"></audio>

        <!-- Page content -->
        <div id="page-content" class="flex-grow flex flex-col justify-center items-center text-center overflow-auto">
            
            <!-- Page 0: Title -->
            <div id="page-0" class="page w-full h-full flex-col md:flex-row justify-center items-center gap-4 md:gap-8">
                <div class="flex flex-col items-center">
                    <button data-audio="gwaenchanayo" class="interactive-card text-3xl sm:text-5xl lg:text-7xl font-extrabold text-slate-800 mb-2 bg-sky-100 px-4 py-2 sm:px-6 sm:py-3 rounded-2xl">Í¥úÏ∞ÆÏïÑÏöî</button>
                    <p class="text-2xl sm:text-3xl lg:text-4xl font-semibold text-sky-600 mt-1 sm:mt-2">Ce n'est pas grave</p>
                </div>
                <img src="https://static.wixstatic.com/media/699687_befeedf13d46487c9b70f44d5b55092e~mv2.png" 
                     alt="Illustration of a person giving a thumbs up" 
                     class="w-24 h-24 sm:w-36 sm:h-36 md:w-64 md:h-64 object-contain"
                     onerror="this.style.display='none'">
            </div>

            <!-- Page 1: Explanation -->
            <div id="page-1" class="page w-full h-full flex-col justify-center items-center text-base sm:text-lg lg:text-xl text-slate-700 leading-relaxed max-w-4xl">
                 <p class="mb-4 sm:mb-6 text-lg sm:text-xl lg:text-2xl">"<span class="font-bold text-sky-600 text-xl sm:text-2xl lg:text-3xl">Í¥úÏ∞ÆÏïÑÏöî</span>" signifie "il n'y a pas de probl√®me".<br>Cela correspond √† "<span class="font-bold">√ßa va</span>" ou "<span class="font-bold">Ce n‚Äôest pas grave</span>".</p>
                 <div class="flex items-center justify-center space-x-2 text-lg sm:text-3xl">
                     <div class="text-center p-2 sm:p-3 bg-amber-100 rounded-lg">
                         <p class="font-bold text-amber-800">Í¥úÏ∞Æ</p>
                         <p class="text-sm sm:text-lg text-amber-600 mt-1">pas de probl√®me</p>
                     </div>
                     <p class="text-xl sm:text-4xl">+</p>
                     <div class="text-center p-2 sm:p-3 bg-teal-100 rounded-lg">
                         <p class="font-bold text-teal-800">ÏïÑÏöî</p>
                         <p class="text-sm sm:text-lg text-teal-600 mt-1">terminaison polie</p>
                     </div>
                 </div>
                 <p class="mt-6 text-base sm:text-lg">On peut aussi utiliser <span class="font-bold text-sky-600">"Í¥úÏ∞ÆÏïÑÏöî?"</span> comme une question pour demander √† quelqu'un si √ßa va.</p>
            </div>

            <!-- Page 2: Syllable practice -->
            <div id="page-2" class="page w-full h-full flex-col justify-center items-center">
                <h2 class="text-xl sm:text-2xl lg:text-3xl font-semibold text-slate-800 mb-4 sm:mb-8">R√©p√©tez chaque syllabe.</h2>
                <div class="flex justify-center items-center gap-1 sm:gap-2 md:gap-4 mb-4">
                    <button data-audio="gwaen" class="interactive-card text-2xl sm:text-4xl lg:text-6xl font-bold text-slate-700 p-2 sm:p-3 lg:p-4 bg-slate-100 rounded-xl">Í¥ú</button>
                    <button data-audio="chan" class="interactive-card text-2xl sm:text-4xl lg:text-6xl font-bold text-slate-700 p-2 sm:p-3 lg:p-4 bg-slate-100 rounded-xl">Ï∞Æ</button>
                    <button data-audio="a" class="interactive-card text-2xl sm:text-4xl lg:text-6xl font-bold text-slate-700 p-2 sm:p-3 lg:p-4 bg-slate-100 rounded-xl">ÏïÑ</button>
                    <button data-audio="yo" class="interactive-card text-2xl sm:text-4xl lg:text-6xl font-bold text-slate-700 p-2 sm:p-3 lg:p-4 bg-slate-100 rounded-xl">Ïöî</button>
                </div>
                <p class="text-base sm:text-lg text-slate-600 max-w-xl">üí° <strong>Astuce :</strong> Dans la syllabe <span class="font-bold text-sky-600">'Ï∞Æ'</span>, la consonne finale '„Ñ¥„Öé' se prononce comme un '„Ñ¥' (n).</p>
            </div>

            <!-- Page 3: Read together -->
            <div id="page-3" class="page w-full h-full flex-col justify-center items-center">
                <h2 class="text-xl sm:text-2xl lg:text-3xl font-semibold text-slate-800 mb-4 sm:mb-8">Maintenant, lisez tout en une fois.</h2>
                <button data-audio="gwaenchanayo" class="interactive-card text-3xl sm:text-5xl lg:text-7xl font-extrabold text-slate-800 mb-4 bg-sky-100 px-4 py-2 sm:px-6 sm:py-3 rounded-2xl">Í¥úÏ∞ÆÏïÑÏöî</button>
            </div>

            <!-- Page 4: Read as Question -->
            <div id="page-4" class="page w-full h-full flex-col justify-center items-center">
                <h2 class="text-xl sm:text-2xl lg:text-3xl font-semibold text-slate-800 mb-4 sm:mb-8">Lisez-le comme une question.</h2>
                <button data-audio="gwaenchanayo-q" class="interactive-card text-3xl sm:text-5xl lg:text-7xl font-extrabold text-slate-800 mb-4 bg-sky-100 px-4 py-2 sm:px-6 sm:py-3 rounded-2xl">Í¥úÏ∞ÆÏïÑÏöî?</button>
                <p class="text-base sm:text-xl text-slate-600 max-w-xl mt-4">Pour poser une question, montez l'intonation √† la fin de la phrase.</p>
            </div>

            <!-- Page 5: Quiz 1 -->
            <div id="page-5" class="page w-full h-full flex-col justify-center items-center">
                <h2 class="text-base sm:text-xl lg:text-2xl font-semibold text-slate-800 mb-4 sm:mb-6">Que signifie <button data-audio="desole" class="text-sky-600 font-bold hover:underline">"D√©sol√©"</button> en cor√©en ?</h2>
                <form id="quiz-1" class="w-full max-w-md">
                    <div class="space-y-2 sm:space-y-4">
                        <div class="quiz-option"><input type="radio" name="q1" value="Í∞êÏÇ¨Ìï©ÎãàÎã§" id="q1a1" class="hidden"><label for="q1a1" class="block cursor-pointer p-2 sm:p-4 border-2 border-slate-200 rounded-lg text-lg sm:text-2xl font-bold">Í∞êÏÇ¨Ìï©ÎãàÎã§</label></div>
                        <div class="quiz-option"><input type="radio" name="q1" value="Ï£ÑÏÜ°Ìï©ÎãàÎã§" id="q1a2" class="hidden"><label for="q1a2" class="block cursor-pointer p-2 sm:p-4 border-2 border-slate-200 rounded-lg text-lg sm:text-2xl font-bold">Ï£ÑÏÜ°Ìï©ÎãàÎã§</label></div>
                        <div class="quiz-option"><input type="radio" name="q1" value="Ïñ¥ÏÑú Ïò§ÏÑ∏Ïöî" id="q1a3" class="hidden"><label for="q1a3" class="block cursor-pointer p-2 sm:p-4 border-2 border-slate-200 rounded-lg text-lg sm:text-2xl font-bold">Ïñ¥ÏÑú Ïò§ÏÑ∏Ïöî</label></div>
                    </div>
                    <div class="feedback-message text-base sm:text-xl"></div>
                    <button type="submit" class="w-full mt-2 sm:mt-4 bg-sky-500 text-white font-bold py-2 px-4 sm:py-3 sm:px-6 rounded-lg hover:bg-sky-600 transition-colors text-sm sm:text-base">V√©rifier</button>
                </form>
            </div>
            
            <!-- Page 6: Quiz 2 -->
            <div id="page-6" class="page w-full h-full flex-col justify-center items-center">
                <h2 class="text-base sm:text-xl lg:text-2xl font-semibold text-slate-800 mb-4 sm:mb-6">Que signifie <button data-audio="bon-retour" class="text-sky-600 font-bold hover:underline">"Bon retour"</button> en cor√©en ?</h2>
                <form id="quiz-2" class="w-full max-w-md">
                    <div class="space-y-2 sm:space-y-4">
                        <div class="quiz-option"><input type="radio" name="q2" value="ÏïàÎÖïÌïòÏÑ∏Ïöî" id="q2a1" class="hidden"><label for="q2a1" class="block cursor-pointer p-2 sm:p-4 border-2 border-slate-200 rounded-lg text-lg sm:text-2xl font-bold">ÏïàÎÖïÌïòÏÑ∏Ïöî</label></div>
                        <div class="quiz-option"><input type="radio" name="q2" value="ÏïàÎÖïÌûà Í∞ÄÏÑ∏Ïöî" id="q2a2" class="hidden"><label for="q2a2" class="block cursor-pointer p-2 sm:p-4 border-2 border-slate-200 rounded-lg text-lg sm:text-2xl font-bold">ÏïàÎÖïÌûà Í∞ÄÏÑ∏Ïöî</label></div>
                        <div class="quiz-option"><input type="radio" name="q2" value="ÏïàÎÖïÌûà Í≥ÑÏÑ∏Ïöî" id="q2a3" class="hidden"><label for="q2a3" class="block cursor-pointer p-2 sm:p-4 border-2 border-slate-200 rounded-lg text-lg sm:text-2xl font-bold">ÏïàÎÖïÌûà Í≥ÑÏÑ∏Ïöî</label></div>
                    </div>
                    <div class="feedback-message text-base sm:text-xl"></div>
                    <button type="submit" class="w-full mt-2 sm:mt-4 bg-sky-500 text-white font-bold py-2 px-4 sm:py-3 sm:px-6 rounded-lg hover:bg-sky-600 transition-colors text-sm sm:text-base">V√©rifier</button>
                </form>
            </div>

            <!-- Page 7: Quiz 3 (Ordering) -->
            <div id="page-7" class="page w-full h-full flex-col justify-center items-center">
                <h2 class="text-base sm:text-xl lg:text-2xl font-semibold text-slate-800 mb-4">Formez <button data-audio="ce-nest-pas-grave" class="text-sky-600 font-bold hover:underline">"Ce n‚Äôest pas grave"</button> en cliquant sur les cartes.</h2>
                <form id="quiz-3" class="w-full max-w-lg">
                    <div id="q3-answer-box" class="order-answer-box w-full p-2 sm:p-4 mb-4 rounded-lg flex items-center justify-center gap-2"></div>
                    <div class="flex justify-center items-center gap-2">
                        <div id="q3-options" class="flex justify-center items-center flex-wrap gap-2 sm:gap-3">
                            <!-- Options will be injected by JS -->
                        </div>
                        <button type="button" data-quiz-id="3" class="backspace-btn text-lg sm:text-2xl bg-slate-300 text-slate-700 font-bold p-2 sm:p-3 rounded-lg hover:bg-slate-400">‚Üê</button>
                    </div>
                    <div class="feedback-message text-base sm:text-xl"></div>
                    <button type="submit" class="w-full sm:w-auto mt-2 sm:mt-4 bg-sky-500 text-white font-bold py-2 px-4 sm:py-3 sm:px-6 rounded-lg hover:bg-sky-600 text-sm sm:text-base">V√©rifier</button>
                </form>
            </div>
            
            <!-- Page 8: Quiz 4 (Ordering Review) -->
            <div id="page-8" class="page w-full h-full flex-col justify-center items-center">
                <h2 class="text-base sm:text-xl lg:text-2xl font-semibold text-slate-800 mb-4">Formez <button data-audio="merci" class="text-sky-600 font-bold hover:underline">"Merci"</button> en ordonnant les syllabes.</h2>
                <form id="quiz-4" class="w-full max-w-2xl">
                    <div id="q4-answer-box" class="order-answer-box w-full p-2 sm:p-4 mb-4 rounded-lg flex items-center justify-center gap-2 text-lg sm:text-3xl"></div>
                    <div class="flex justify-center items-center gap-2">
                        <div id="q4-options" class="flex justify-center items-center flex-wrap gap-2">
                            <!-- Options will be injected by JS -->
                        </div>
                        <button type="button" data-quiz-id="4" class="backspace-btn text-lg sm:text-2xl bg-slate-300 text-slate-700 font-bold p-2 sm:p-3 rounded-lg hover:bg-slate-400">‚Üê</button>
                    </div>
                    <div class="feedback-message text-base sm:text-xl"></div>
                    <button type="submit" class="w-full sm:w-auto mt-2 sm:mt-4 bg-sky-500 text-white font-bold py-2 px-4 sm:py-3 sm:px-6 rounded-lg hover:bg-sky-600 text-sm sm:text-base">V√©rifier</button>
                </form>
            </div>

            <!-- Page 9: Quiz 5 (Ordering Review) -->
            <div id="page-9" class="page w-full h-full flex-col justify-center items-center">
                <h2 class="text-base sm:text-xl lg:text-2xl font-semibold text-slate-800 mb-4">Formez <button data-audio="desole" class="text-sky-600 font-bold hover:underline">"D√©sol√©"</button> en ordonnant les syllabes.</h2>
                <form id="quiz-5" class="w-full max-w-2xl">
                    <div id="q5-answer-box" class="order-answer-box w-full p-2 sm:p-4 mb-4 rounded-lg flex items-center justify-center gap-2 text-lg sm:text-3xl"></div>
                    <div class="flex justify-center items-center gap-2">
                        <div id="q5-options" class="flex justify-center items-center flex-wrap gap-2">
                            <!-- Options will be injected by JS -->
                        </div>
                        <button type="button" data-quiz-id="5" class="backspace-btn text-lg sm:text-2xl bg-slate-300 text-slate-700 font-bold p-2 sm:p-3 rounded-lg hover:bg-slate-400">‚Üê</button>
                    </div>
                    <div class="feedback-message text-base sm:text-xl"></div>
                    <button type="submit" class="w-full sm:w-auto mt-2 sm:mt-4 bg-sky-500 text-white font-bold py-2 px-4 sm:py-3 sm:px-6 rounded-lg hover:bg-sky-600 text-sm sm:text-base">V√©rifier</button>
                </form>
            </div>
            
            <!-- Page 10: Keyboard Quiz 6 -->
            <div id="page-10" class="page w-full h-full flex-col justify-center items-center">
                 <form id="quiz-6" class="w-full max-w-xl flex flex-col items-center">
                     <h2 class="text-base sm:text-xl lg:text-2xl font-semibold text-slate-800 mb-4">√âcrivez <button data-audio="bienvenue" class="text-sky-600 font-bold hover:underline">"Bienvenue"</button> en cor√©en.</h2>
                     <div class="quiz-input-container">
                         <button type="button" data-audio="bienvenue" class="audio-hint-btn">
                             <svg class="w-4 h-4 sm:w-6 sm:h-6" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M9.383 3.076A1 1 0 0110 4v12a1 1 0 01-1.707.707L4.586 13H2a1 1 0 01-1-1V8a1 1 0 011-1h2.586l3.707-3.707a1 1 0 011.09-.217zM14.657 2.929a1 1 0 011.414 0A9.972 9.972 0 0119 10a9.972 9.972 0 01-2.929 7.071 1 1 0 01-1.414-1.414A7.971 7.971 0 0017 10c0-2.21-.894-4.208-2.343-5.657a1 1 0 010-1.414zm-2.829 2.828a1 1 0 011.415 0A5.983 5.983 0 0115 10a5.984 5.984 0 01-1.757 4.243 1 1 0 01-1.415-1.415A3.984 3.984 0 0013 10a3.983 3.983 0 00-1.172-2.828 1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
                         </button>
                         <div class="quiz-input-wrapper">
                             <span class="quiz-input" data-quiz-id="6" style="min-width: 10rem; sm:min-width: 15rem;"></span>
                         </div>
                     </div>
                     <div class="keyboard-container mt-2 sm:mt-4" data-quiz-id="6"></div>
                     <div class="feedback-message text-base sm:text-xl"></div>
                     <button type="submit" class="w-full sm:w-auto mt-2 sm:mt-4 bg-sky-500 text-white font-bold py-2 px-4 sm:py-3 sm:px-6 rounded-lg hover:bg-sky-600 text-sm sm:text-base">V√©rifier</button>
                 </form>
            </div>

            <!-- Page 11: Keyboard Quiz 7 -->
            <div id="page-11" class="page w-full h-full flex-col justify-center items-center">
                 <form id="quiz-7" class="w-full max-w-xl flex flex-col items-center">
                     <h2 class="text-base sm:text-xl lg:text-2xl font-semibold text-slate-800 mb-4">√âcrivez <button data-audio="merci" class="text-sky-600 font-bold hover:underline">"Merci"</button> en cor√©en.</h2>
                     <div class="quiz-input-container">
                         <button type="button" data-audio="merci" class="audio-hint-btn">
                             <svg class="w-4 h-4 sm:w-6 sm:h-6" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M9.383 3.076A1 1 0 0110 4v12a1 1 0 01-1.707.707L4.586 13H2a1 1 0 01-1-1V8a1 1 0 011-1h2.586l3.707-3.707a1 1 0 011.09-.217zM14.657 2.929a1 1 0 011.414 0A9.972 9.972 0 0119 10a9.972 9.972 0 01-2.929 7.071 1 1 0 01-1.414-1.414A7.971 7.971 0 0017 10c0-2.21-.894-4.208-2.343-5.657a1 1 0 010-1.414zm-2.829 2.828a1 1 0 011.415 0A5.983 5.983 0 0115 10a5.984 5.984 0 01-1.757 4.243 1 1 0 01-1.415-1.415A3.984 3.984 0 0013 10a3.983 3.983 0 00-1.172-2.828 1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
                         </button>
                         <div class="quiz-input-wrapper">
                             <span class="quiz-input" data-quiz-id="7" style="min-width: 10rem; sm:min-width: 15rem;"></span>
                         </div>
                     </div>
                     <div class="keyboard-container mt-2 sm:mt-4" data-quiz-id="7"></div>
                     <div class="feedback-message text-base sm:text-xl"></div>
                     <button type="submit" class="w-full sm:w-auto mt-2 sm:mt-4 bg-sky-500 text-white font-bold py-2 px-4 sm:py-3 sm:px-6 rounded-lg hover:bg-sky-600 text-sm sm:text-base">V√©rifier</button>
                 </form>
            </div>

            <!-- Page 12: Keyboard Quiz 8 -->
            <div id="page-12" class="page w-full h-full flex-col justify-center items-center">
                 <form id="quiz-8" class="w-full max-w-xl flex flex-col items-center">
                     <h2 class="text-base sm:text-xl lg:text-2xl font-semibold text-slate-800 mb-4">√âcrivez <button data-audio="restez-bien" class="text-sky-600 font-bold hover:underline">"Restez bien"</button> en cor√©en.</h2>
                     <div class="quiz-input-container">
                         <button type="button" data-audio="restez-bien" class="audio-hint-btn">
                             <svg class="w-4 h-4 sm:w-6 sm:h-6" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M9.383 3.076A1 1 0 0110 4v12a1 1 0 01-1.707.707L4.586 13H2a1 1 0 01-1-1V8a1 1 0 011-1h2.586l3.707-3.707a1 1 0 011.09-.217zM14.657 2.929a1 1 0 011.414 0A9.972 9.972 0 0119 10a9.972 9.972 0 01-2.929 7.071 1 1 0 01-1.414-1.414A7.971 7.971 0 0017 10c0-2.21-.894-4.208-2.343-5.657a1 1 0 010-1.414zm-2.829 2.828a1 1 0 011.415 0A5.983 5.983 0 0115 10a5.984 5.984 0 01-1.757 4.243 1 1 0 01-1.415-1.415A3.984 3.984 0 0013 10a3.983 3.983 0 00-1.172-2.828 1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
                         </button>
                         <div class="quiz-input-wrapper">
                             <span class="quiz-input" data-quiz-id="8" style="min-width: 10rem; sm:min-width: 15rem;"></span>
                         </div>
                     </div>
                     <div class="keyboard-container mt-2 sm:mt-4" data-quiz-id="8"></div>
                     <div class="feedback-message text-base sm:text-xl"></div>
                     <button type="submit" class="w-full sm:w-auto mt-2 sm:mt-4 bg-sky-500 text-white font-bold py-2 px-4 sm:py-3 sm:px-6 rounded-lg hover:bg-sky-600 text-sm sm:text-base">V√©rifier</button>
                 </form>
            </div>

            <!-- Page 13: Keyboard Quiz 9 -->
            <div id="page-13" class="page w-full h-full flex-col justify-center items-center">
                 <form id="quiz-9" class="w-full max-w-xl flex flex-col items-center">
                     <h2 class="text-base sm:text-xl lg:text-2xl font-semibold text-slate-800 mb-4">√âcrivez <button data-audio="ce-nest-pas-grave" class="text-sky-600 font-bold hover:underline">"Ce n‚Äôest pas grave"</button>.</h2>
                     <div class="quiz-input-container">
                         <button type="button" data-audio="ce-nest-pas-grave" class="audio-hint-btn">
                             <svg class="w-4 h-4 sm:w-6 sm:h-6" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M9.383 3.076A1 1 0 0110 4v12a1 1 0 01-1.707.707L4.586 13H2a1 1 0 01-1-1V8a1 1 0 011-1h2.586l3.707-3.707a1 1 0 011.09-.217zM14.657 2.929a1 1 0 011.414 0A9.972 9.972 0 0119 10a9.972 9.972 0 01-2.929 7.071 1 1 0 01-1.414-1.414A7.971 7.971 0 0017 10c0-2.21-.894-4.208-2.343-5.657a1 1 0 010-1.414zm-2.829 2.828a1 1 0 011.415 0A5.983 5.983 0 0115 10a5.984 5.984 0 01-1.757 4.243 1 1 0 01-1.415-1.415A3.984 3.984 0 0013 10a3.983 3.983 0 00-1.172-2.828 1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
                         </button>
                         <div class="quiz-input-wrapper">
                             <span class="prefilled-text">Í¥úÏ∞Æ</span>
                             <span class="quiz-input" data-quiz-id="9" style="min-width: 6rem; sm:min-width: 9rem;"></span>
                         </div>
                     </div>
                     <div class="keyboard-container mt-2 sm:mt-4" data-quiz-id="9"></div>
                     <div class="feedback-message text-base sm:text-xl"></div>
                     <button type="submit" class="w-full sm:w-auto mt-2 sm:mt-4 bg-sky-500 text-white font-bold py-2 px-4 sm:py-3 sm:px-6 rounded-lg hover:bg-sky-600 text-sm sm:text-base">V√©rifier</button>
                 </form>
            </div>

            <!-- Page 14: Keyboard Quiz 10 -->
            <div id="page-14" class="page w-full h-full flex-col justify-center items-center">
                 <form id="quiz-10" class="w-full max-w-xl flex flex-col items-center">
                     <h2 class="text-base sm:text-xl lg:text-2xl font-semibold text-slate-800 mb-4">√âcrivez <button data-audio="ca-va-question" class="text-sky-600 font-bold hover:underline">"√áa va?"</button></h2>
                     <div class="quiz-input-container">
                         <button type="button" data-audio="ca-va-question" class="audio-hint-btn">
                             <svg class="w-4 h-4 sm:w-6 sm:h-6" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M9.383 3.076A1 1 0 0110 4v12a1 1 0 01-1.707.707L4.586 13H2a1 1 0 01-1-1V8a1 1 0 011-1h2.586l3.707-3.707a1 1 0 011.09-.217zM14.657 2.929a1 1 0 011.414 0A9.972 9.972 0 0119 10a9.972 9.972 0 01-2.929 7.071 1 1 0 01-1.414-1.414A7.971 7.971 0 0017 10c0-2.21-.894-4.208-2.343-5.657a1 1 0 010-1.414zm-2.829 2.828a1 1 0 011.415 0A5.983 5.983 0 0115 10a5.984 5.984 0 01-1.757 4.243 1 1 0 01-1.415-1.415A3.984 3.984 0 0013 10a3.983 3.983 0 00-1.172-2.828 1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
                         </button>
                         <div class="quiz-input-wrapper">
                             <span class="quiz-input" data-quiz-id="10" style="min-width: 6rem; sm:min-width: 9rem;"></span>
                             <span class="prefilled-text">ÏïÑÏöî?</span>
                         </div>
                     </div>
                     <div class="keyboard-container mt-2 sm:mt-4" data-quiz-id="10"></div>
                     <div class="feedback-message text-base sm:text-xl"></div>
                     <button type="submit" class="w-full sm:w-auto mt-2 sm:mt-4 bg-sky-500 text-white font-bold py-2 px-4 sm:py-3 sm:px-6 rounded-lg hover:bg-sky-600 text-sm sm:text-base">V√©rifier</button>
                 </form>
            </div>

            <!-- Page 15: Keyboard Quiz 11 -->
            <div id="page-15" class="page w-full h-full flex-col justify-center items-center">
                 <form id="quiz-11" class="w-full max-w-xl flex flex-col items-center">
                     <h2 class="text-base sm:text-xl lg:text-2xl font-semibold text-slate-800 mb-4">√âcrivez <button data-audio="ca-va-question" class="text-sky-600 font-bold hover:underline">"√áa va?"</button> en entier.</h2>
                     <div class="quiz-input-container">
                         <div class="quiz-input-wrapper">
                             <span class="quiz-input" data-quiz-id="11" style="min-width: 10rem; sm:min-width: 15rem;"></span>
                         </div>
                     </div>
                     <div class="keyboard-container mt-2 sm:mt-4" data-quiz-id="11"></div>
                     <div class="feedback-message text-base sm:text-xl"></div>
                     <button type="submit" class="w-full sm:w-auto mt-2 sm:mt-4 bg-sky-500 text-white font-bold py-2 px-4 sm:py-3 sm:px-6 rounded-lg hover:bg-sky-600 text-sm sm:text-base">V√©rifier</button>
                 </form>
            </div>

            <!-- Page 16: Keyboard Quiz 12 -->
            <div id="page-16" class="page w-full h-full flex-col justify-center items-center">
                 <form id="quiz-12" class="w-full max-w-xl flex flex-col items-center">
                     <h2 class="text-base sm:text-xl lg:text-2xl font-semibold text-slate-800 mb-4">√âcrivez: "D√©sol√©. √áa va?"</h2>
                     <div class="quiz-input-container">
                         <div class="quiz-input-wrapper">
                             <span class="quiz-input" data-quiz-id="12" style="min-width: 12rem; sm:min-width: 15rem;"></span>
                         </div>
                     </div>
                     <div class="keyboard-container mt-2 sm:mt-4" data-quiz-id="12"></div>
                     <div class="feedback-message text-base sm:text-xl"></div>
                     <button type="submit" class="w-full sm:w-auto mt-2 sm:mt-4 bg-sky-500 text-white font-bold py-2 px-4 sm:py-3 sm:px-6 rounded-lg hover:bg-sky-600 text-sm sm:text-base">V√©rifier</button>
                 </form>
            </div>

            <!-- Page 17: Keyboard Quiz 13 -->
            <div id="page-17" class="page w-full h-full flex-col justify-center items-center">
                 <form id="quiz-13" class="w-full max-w-xl flex flex-col items-center">
                     <h2 class="text-base sm:text-xl lg:text-2xl font-semibold text-slate-800 mb-4">√âcrivez: "Merci, ce n'est pas grave."</h2>
                     <div class="quiz-input-container">
                         <div class="quiz-input-wrapper">
                             <span class="quiz-input" data-quiz-id="13" style="min-width: 12rem; sm:min-width: 15rem;"></span>
                         </div>
                     </div>
                     <div class="keyboard-container mt-2 sm:mt-4" data-quiz-id="13"></div>
                     <div class="feedback-message text-base sm:text-xl"></div>
                     <button type="submit" class="w-full sm:w-auto mt-2 sm:mt-4 bg-sky-500 text-white font-bold py-2 px-4 sm:py-3 sm:px-6 rounded-lg hover:bg-sky-600 text-sm sm:text-base">V√©rifier</button>
                 </form>
            </div>

            <!-- Page 18: End -->
            <div id="page-18" class="page w-full h-full flex-col justify-center items-center">
                <h2 class="text-2xl sm:text-3xl lg:text-4xl font-bold text-slate-800">ÏàòÍ≥†ÌïòÏÖ®ÏäµÎãàÎã§!</h2>
                <p class="text-base sm:text-lg lg:text-xl text-slate-600 mt-2 sm:mt-4">F√©licitations ! Vous avez appris une autre expression utile !</p>
            </div>
        </div>

        <!-- Navigation: Grid for fixed layout -->
        <div id="navigation-bar" class="absolute bottom-4 sm:bottom-6 lg:bottom-8 left-0 right-0 px-4 sm:px-8 grid grid-cols-[80px_1fr_80px] sm:grid-cols-[120px_1fr_120px] items-center gap-4">
            <!-- Left: Previous Button -->
            <div class="flex justify-start">
                <button id="prev-btn" class="bg-slate-200 text-slate-600 font-bold py-1.5 px-3 text-sm sm:py-2 sm:px-5 sm:text-base rounded-lg hover:bg-slate-300 transition-colors">Pr√©c√©dent</button>
            </div>
            
            <!-- Center: Progress Bar -->
            <div class="w-full h-2 bg-slate-200 rounded-full overflow-hidden">
                <div id="progress-indicator" class="h-full bg-sky-500 transition-all duration-300"></div>
            </div>
            
            <!-- Right: Next/Retry Buttons -->
            <div class="flex justify-end gap-2">
                <button id="retry-btn" class="hidden bg-amber-500 text-white font-bold py-1.5 px-3 text-sm sm:py-2 sm:px-5 sm:text-base rounded-lg hover:bg-amber-600 transition-colors">R√©essayer</button>
                <button id="next-btn" class="bg-sky-500 text-white font-bold py-1.5 px-3 text-sm sm:py-2 sm:px-5 sm:text-base rounded-lg hover:bg-sky-600 transition-colors">Suivant</button>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- Basic Setup ---
        const totalPages = 19; // 0-18
        let currentPageIndex = 0;
        let soundsReady = false;

        const pages = document.querySelectorAll('.page');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        const retryBtn = document.getElementById('retry-btn');
        const progressBar = document.getElementById('progress-indicator');

        // --- Sound Setup ---
        let correctSound, wrongSound, pageTurnSound, finishSound;
        const initAudio = async () => {
            if (soundsReady) return;
            try {
                await Tone.start();
                correctSound = new Tone.Synth({ oscillator: { type: 'sine' }, envelope: { attack: 0.01, decay: 0.2, sustain: 0.2, release: 0.2 } }).toDestination();
                wrongSound = new Tone.Synth({ oscillator: { type: 'triangle' }, envelope: { attack: 0.01, decay: 0.4, sustain: 0.1, release: 0.2 } }).toDestination();
                pageTurnSound = new Tone.Synth({ oscillator: { type: 'sine' }, envelope: { attack: 0.005, decay: 0.1, sustain: 0, release: 0.1 } }).toDestination();
                finishSound = new Tone.PolySynth(Tone.Synth, { envelope: { attack: 0.05, decay: 0.4, sustain: 0.3, release: 1 } }).toDestination();
                soundsReady = true;
            } catch (e) {
                console.error("Audio context start failed:", e);
            }
        };
        
        // --- Audio Player & Mapping ---
        const hangulToAudioId = {
            'Í¥úÏ∞ÆÏïÑÏöî': 'gwaenchanayo', 'Í¥úÏ∞ÆÏïÑÏöî?': 'gwaenchanayo-q', 'Í¥úÏ∞Æ': 'gwaenchan', 'ÏïÑÏöî': 'ayo', 'Í¥ú': 'gwaen', 'Ï∞Æ': 'chan', 'ÏïÑ': 'a',
            'ÏïàÎÖïÌïòÏÑ∏Ïöî': 'annyeonghaseyo', 'Í∞êÏÇ¨Ìï©ÎãàÎã§': 'gamsahamnida', 'Ï£ÑÏÜ°Ìï©ÎãàÎã§': 'joesonghamnida', 'ÏïàÎÖïÌûà Í≥ÑÏÑ∏Ïöî': 'annyeonghi-gyeseyo',
            'ÏïàÎÖïÌûà Í∞ÄÏÑ∏Ïöî': 'annyeonghi-gaseyo', 'Ïñ¥ÏÑú Ïò§ÏÑ∏Ïöî': 'eoseo-oseyo', 'Ïöî': 'yo', 'Ìûà': 'hi', 'Ï£Ñ': 'joe', 'ÏÜ°': 'song', 'Í∞ê': 'gam', 'ÏÇ¨': 'sa',
            'ÎÖï': 'nyeong', 'Ïïà': 'an', 'Îã§': 'da', 'ÌïòÏÑ∏Ïöî': 'haseyo', 'Ïò§ÏÑ∏Ïöî': 'oseyo', 'Ïñ¥ÏÑú': 'eoseo', 'Í∞Ä': 'ga', 'ÏÑ∏': 'se',
            'ÏïàÎÖïÌûà': 'annyeonghi', 'Í≥ÑÏÑ∏Ïöî': 'gyeseyo', 'Îãà': 'ni', 'Ìï©': 'hap', 'Í≥Ñ': 'gye', 'Ïñ¥Ïöî': 'eoyo', 'Ìï¥Ïöî': 'haeyo'
        };
        const playAudio = (id) => {
            const audio = document.getElementById(`audio-${id}`);
            if (audio && audio.src && !audio.src.endsWith(window.location.pathname)) { 
                audio.currentTime = 0;
                audio.play().catch(e => console.error("Audio play failed:", e));
            }
        };
        document.querySelectorAll('[data-audio]').forEach(btn => {
            btn.addEventListener('click', async (e) => {
                e.stopPropagation();
                await initAudio();
                playAudio(btn.dataset.audio);
            });
        });

        // --- Page Management ---
        const showPage = (index) => {
            pages.forEach((page, i) => page.classList.toggle('active', i === index));
            updateNavigation(index);
            updateProgressBar(index);
            
            // Play finish sound on last page
            if (index === totalPages - 1) {
                if (soundsReady) {
                    finishSound.triggerAttackRelease(['C4', 'E4', 'G4', 'C5'], '0.5s');
                }
            }
        };
        
        const updateNavigation = (index) => {
            // Use visibility to maintain layout
            prevBtn.style.visibility = index > 0 ? 'visible' : 'hidden';
            
            const currentPage = pages[index];
            const isQuizPage = currentPage.querySelector('form') !== null;
            const isQuizAnswered = currentPage.dataset.answered === 'true';

            // Always hide Retry button initially when navigating
            retryBtn.classList.add('hidden'); 

            // Handle Next Button Visibility
            if (index === totalPages - 1) {
                nextBtn.style.visibility = 'hidden';
            } else {
                nextBtn.classList.remove('hidden'); // Ensure it's not display:none
                nextBtn.style.visibility = 'visible';
            }
            
            // Handle Next Button Disabled State (visually hidden but technically visibility toggle)
            if (isQuizPage && !isQuizAnswered) {
                nextBtn.style.visibility = 'hidden';
            } else {
                // If not last page, show it
                if (index !== totalPages - 1) {
                    nextBtn.style.visibility = 'visible';
                }
            }
        };

        const updateProgressBar = (index) => {
            progressBar.style.width = `${((index + 1) / totalPages) * 100}%`;
        };
        
        // --- Navigation Events ---
        nextBtn.addEventListener('click', async () => {
            await initAudio();
            
            // Send postMessage when clicking next on the 2nd to last page
            if (currentPageIndex === totalPages - 2) {
                if (parent) {
                    window.parent.postMessage({ type: 'lesson_complete' }, '*');
                }
            }

            if (currentPageIndex < totalPages - 1) {
                currentPageIndex++;
                if (soundsReady) pageTurnSound.triggerAttackRelease('A5', '0.05s');
                showPage(currentPageIndex);
            }
        });
        
        prevBtn.addEventListener('click', async () => {
            await initAudio();
            if (currentPageIndex > 0) {
                currentPageIndex--;
                if (soundsReady) pageTurnSound.triggerAttackRelease('G5', '0.05s');
                showPage(currentPageIndex);
            }
        });
        retryBtn.addEventListener('click', async () => {
            await initAudio();
            const quizInfo = quizzes.find(q => q.pageIndex === currentPageIndex);
            if(quizInfo) resetQuiz(quizInfo.id);
        });
        
        // --- Hangul Keyboard Logic Factory ---
        const createHangulComposer = () => {
            const CHO = ['„Ñ±','„Ñ≤','„Ñ¥','„Ñ∑','„Ñ∏','„Ñπ','„ÖÅ','„ÖÇ','„ÖÉ','„ÖÖ','„ÖÜ','„Öá','„Öà','„Öâ','„Öä','„Öã','„Öå','„Öç','„Öé'];
            const JUNG = ['„Öè','„Öê','„Öë','„Öí','„Öì','„Öî','„Öï','„Öñ','„Öó','„Öò','„Öô','„Öö','„Öõ','„Öú','„Öù','„Öû','„Öü','„Ö†','„Ö°','„Ö¢','„Ö£'];
            const JONG = ['','„Ñ±','„Ñ≤','„Ñ≥','„Ñ¥','„Ñµ','„Ñ∂','„Ñ∑','„Ñπ','„Ñ∫','„Ñª','„Ñº','„ÑΩ','„Ñæ','„Ñø','„ÖÄ','„ÖÅ','„ÖÇ','„ÖÑ','„ÖÖ','„ÖÜ','„Öá','„Öà','„Öä','„Öã','„Öå','„Öç','„Öé'];
            const HANGUL_OFFSET = 0xAC00;
            const JUNG_PAIRS = { '„Öó„Öè': '„Öò', '„Öó„Öê': '„Öô', '„Öó„Ö£': '„Öö', '„Öú„Öì': '„Öù', '„Öú„Öî': '„Öû', '„Öú„Ö£': '„Öü', '„Ö°„Ö£': '„Ö¢' };
            const JONG_PAIRS = { '„Ñ±„ÖÖ': '„Ñ≥', '„Ñ¥„Öà': '„Ñµ', '„Ñ¥„Öé': '„Ñ∂', '„Ñπ„Ñ±': '„Ñ∫', '„Ñπ„ÖÅ': '„Ñª', '„Ñπ„ÖÇ': '„Ñº', '„Ñπ„ÖÖ': '„ÑΩ', '„Ñπ„Öå': '„Ñæ', '„Ñπ„Öç': '„Ñø', '„Ñπ„Öé': '„ÖÄ', '„ÖÇ„ÖÖ': '„ÖÑ' };
            const JONG_DECOMPOSE = Object.fromEntries(Object.entries(JONG_PAIRS).map(([k, v]) => [v, k]));
            const isVowel = c => JUNG.includes(c);
            let cho, jung, jong, buffer;

            const resetState = () => { cho = null; jung = null; jong = null; };
            const flush = () => {
                if (cho !== null) {
                    const choIndex = CHO.indexOf(cho);
                    const jungIndex = JUNG.indexOf(jung);
                    const jongIndex = JONG.indexOf(jong || '');
                    if (jungIndex > -1) buffer += String.fromCharCode(HANGUL_OFFSET + (choIndex * 21 + jungIndex) * 28 + jongIndex);
                    else buffer += cho;
                }
                resetState();
            };
            const addChar = (char) => {
                if (char === ' ' || char === ',' || char === '.' || char === '!' || char === '?') {
                    flush();
                    buffer += char;
                    return;
                }
                if (isVowel(char)) {
                    if (cho === null) { flush(); cho = '„Öá'; jung = char; } 
                    else if (jung === null) { jung = char; } 
                    else if (JUNG_PAIRS[jung + char] && jong === null) { jung = JUNG_PAIRS[jung + char]; } 
                    else if (jong === null) { flush(); cho = '„Öá'; jung = char; } 
                    else {
                        const lastJong = jong;
                        const decomposed = JONG_DECOMPOSE[lastJong];
                        jong = null;
                        if(decomposed) {
                            jong = decomposed[0];
                            flush();
                            cho = decomposed[1]; jung = char;
                        } else {
                            flush();
                            cho = lastJong; jung = char;
                        }
                    }
                } else { // isConsonant
                    if (jung === null) { flush(); cho = char; } 
                    else if (jong === null) {
                        if(JONG.includes(char)) jong = char;
                        else { flush(); cho = char; }
                    } else if (JONG_PAIRS[jong + char]) {
                        jong = JONG_PAIRS[jong + char];
                    } else { flush(); cho = char; }
                }
            };
            const reset = () => { resetState(); buffer = ''; };
            reset();

            return {
                process: (char) => {
                    if (char === 'backspace') {
                        if (jong !== null) {
                            const decomposed = JONG_DECOMPOSE[jong];
                            jong = decomposed ? decomposed[0] : null;
                        } else if (jung !== null) {
                             const jungDecomposed = Object.keys(JUNG_PAIRS).find(key => JUNG_PAIRS[key] === jung);
                             jung = jungDecomposed ? jungDecomposed[0] : null;
                        }
                        else if (cho !== null) cho = null;
                        else if (buffer.length > 0) { 
                            flush();
                            buffer = buffer.slice(0, -1);
                        }
                    } else addChar(char);
                    
                    let currentSyllable = '';
                    if (cho !== null) {
                         const choIndex = CHO.indexOf(cho);
                         const jungIndex = JUNG.indexOf(jung);
                         const jongIndex = JONG.indexOf(jong || '');
                         if(jungIndex > -1) currentSyllable = String.fromCharCode(HANGUL_OFFSET + (choIndex * 21 + jungIndex) * 28 + jongIndex);
                         else currentSyllable = cho;
                    }
                    return buffer + currentSyllable;
                },
                reset: reset,
                getFinal: () => { flush(); return buffer; }
            };
        };

        const createKeyboard = (container, onKey, addExtraKeys = false) => {
            const layout = ["„ÖÇ„Öà„Ñ∑„Ñ±„ÖÖ„Öõ„Öï„Öë„Öê„Öî", "„ÖÅ„Ñ¥„Öá„Ñπ„Öé„Öó„Öì„Öè„Ö£", "„Öã„Öå„Öä„Öç„Ö†„Öú„Ö°"];
            const shiftLayout = ["„ÖÉ„Öâ„Ñ∏„Ñ≤„ÖÜ„Öõ„Öï„Öë„Öí„Öñ", "„ÖÅ„Ñ¥„Öá„Ñπ„Öé„Öó„Öì„Öè„Ö£", "„Öã„Öå„Öä„Öç„Ö†„Öú„Ö°"];
            let isShifted = false;

            const render = () => {
                container.innerHTML = '';
                const currentLayout = isShifted ? shiftLayout : layout;
                currentLayout.forEach(row => {
                    const rowDiv = document.createElement('div');
                    rowDiv.className = 'keyboard-row';
                    row.split('').forEach(char => {
                        const keyBtn = document.createElement('button');
                        keyBtn.type = 'button';
                        keyBtn.className = 'key';
                        keyBtn.textContent = char;
                        keyBtn.dataset.char = char;
                        rowDiv.appendChild(keyBtn);
                    });
                    container.appendChild(rowDiv);
                });

                const bottomRow = document.createElement('div');
                bottomRow.className = 'keyboard-row';
                
                const shiftBtn = document.createElement('button');
                Object.assign(shiftBtn, { type: 'button', className: 'key', textContent: 'Shift' });
                shiftBtn.onclick = () => {
                    isShifted = !isShifted;
                    render();
                };

                const backspaceBtn = document.createElement('button');
                Object.assign(backspaceBtn, { type: 'button', className: 'key', textContent: '‚å´' });
                backspaceBtn.dataset.char = 'backspace';
                
                const spaceBtn = document.createElement('button');
                Object.assign(spaceBtn, { type: 'button', className: 'key flex-grow', textContent: 'Space'});
                spaceBtn.dataset.char = ' ';

                if (addExtraKeys) {
                    const commaBtn = document.createElement('button');
                    Object.assign(commaBtn, { type: 'button', className: 'key', textContent: ','});
                    commaBtn.dataset.char = ',';
                    const dotBtn = document.createElement('button');
                    Object.assign(dotBtn, { type: 'button', className: 'key', textContent: '.'});
                    dotBtn.dataset.char = '.';
                    const qBtn = document.createElement('button');
                    Object.assign(qBtn, { type: 'button', className: 'key', textContent: '?'});
                    qBtn.dataset.char = '?';
                    bottomRow.append(shiftBtn, spaceBtn, commaBtn, dotBtn, qBtn, backspaceBtn);
                } else {
                    bottomRow.append(shiftBtn, spaceBtn, backspaceBtn);
                }
                container.appendChild(bottomRow);
            };

            container.addEventListener('click', (e) => {
                const keyEl = e.target.closest('.key');
                if (keyEl && keyEl.dataset.char) {
                    onKey(keyEl.dataset.char);
                    if (isShifted && !e.target.closest('[textContent="Shift"]')) {
                        isShifted = false;
                        render();
                    }
                }
            });

            render();
        };

        // --- Quiz Setup & Logic ---
        const quizzes = [
            { id: 'quiz-1', pageIndex: 5, type: 'radio', answer: 'Ï£ÑÏÜ°Ìï©ÎãàÎã§' },
            { id: 'quiz-2', pageIndex: 6, type: 'radio', answer: 'ÏïàÎÖïÌûà Í∞ÄÏÑ∏Ïöî' },
            { id: 'quiz-3', pageIndex: 7, type: 'order', answer: ['Í¥úÏ∞Æ', 'ÏïÑÏöî'], options: ['ÌïòÏÑ∏Ïöî', 'Í¥úÏ∞Æ', 'Ï£ÑÏÜ°', 'ÏïàÎÖï', 'Ïò§ÏÑ∏Ïöî', 'ÏïÑÏöî', 'Ïñ¥ÏÑú', 'Ìï¥Ïöî', 'Ïñ¥Ïöî'] },
            { id: 'quiz-4', pageIndex: 8, type: 'order', answer: ['Í∞ê','ÏÇ¨','Ìï©','Îãà','Îã§'], options: ['Ìûà', 'ÏÜ°', 'ÏÑ∏', 'ÎÖï', 'Í≥Ñ', 'Í∞ê', 'Ïïà', 'Ïöî', 'Îã§', 'ÏÇ¨', 'Ìï©', 'Îãà'] },
            { id: 'quiz-5', pageIndex: 9, type: 'order', answer: ['Ï£Ñ','ÏÜ°','Ìï©','Îãà','Îã§'], options: ['Í∞Ä', 'ÏÜ°', 'Ìï©', 'Í∞ê', 'Ï£Ñ', 'Îã§', 'Ïöî', 'ÏÑ∏', 'Îãà'] },
            { id: 'quiz-6', pageIndex: 10, type: 'keyboard', answer: 'Ïñ¥ÏÑú Ïò§ÏÑ∏Ïöî' },
            { id: 'quiz-7', pageIndex: 11, type: 'keyboard', answer: 'Í∞êÏÇ¨Ìï©ÎãàÎã§' },
            { id: 'quiz-8', pageIndex: 12, type: 'keyboard', answer: 'ÏïàÎÖïÌûà Í≥ÑÏÑ∏Ïöî' },
            { id: 'quiz-9', pageIndex: 13, type: 'keyboard', answer: 'ÏïÑÏöî' },
            { id: 'quiz-10', pageIndex: 14, type: 'keyboard', answer: 'Í¥úÏ∞Æ' },
            { id: 'quiz-11', pageIndex: 15, type: 'keyboard', answer: 'Í¥úÏ∞ÆÏïÑÏöî?', extraKeys: true },
            { id: 'quiz-12', pageIndex: 16, type: 'keyboard', answer: 'Ï£ÑÏÜ°Ìï©ÎãàÎã§. Í¥úÏ∞ÆÏïÑÏöî?', extraKeys: true },
            { id: 'quiz-13', pageIndex: 17, type: 'keyboard', answer: 'Í∞êÏÇ¨Ìï©ÎãàÎã§, Í¥úÏ∞ÆÏïÑÏöî.', extraKeys: true }
        ];

        let quizStates = {};

        const shuffleArray = (array) => array.sort(() => Math.random() - 0.5);

        const initQuiz = (quizInfo) => {
            const form = document.getElementById(quizInfo.id);
            if (!form) return;
            
            const page = form.closest('.page');
            page.dataset.answered = 'false'; 
            
            const feedbackEl = form.querySelector('.feedback-message');
            if(feedbackEl) feedbackEl.innerHTML = '';
            form.querySelector('button[type=submit]').classList.remove('hidden');

            quizStates[quizInfo.id] = { userAnswer: quizInfo.type.includes('order') ? [] : '' };

            if (quizInfo.type === 'order') {
                const quizNumber = quizInfo.id.match(/\d+/)[0];
                const optionsContainer = document.getElementById(`q${quizNumber}-options`);
                const answerBox = document.getElementById(`q${quizNumber}-answer-box`);
                if (!optionsContainer || !answerBox) return;

                optionsContainer.innerHTML = '';
                answerBox.innerHTML = '';
                
                shuffleArray([...quizInfo.options]).forEach((optionText, index) => {
                    const optionCard = document.createElement('button');
                    optionCard.type = 'button';
                    // Use responsive classes
                    if (quizInfo.id === 'quiz-4' || quizInfo.id === 'quiz-5') {
                        optionCard.className = 'interactive-card order-option-card p-1.5 sm:p-3 text-base sm:text-2xl';
                    } else {
                        optionCard.className = 'interactive-card order-option-card p-2 sm:p-4 text-base sm:text-2xl';
                    }
                    optionCard.textContent = optionText;
                    optionCard.dataset.optionIndex = index;
                    
                    optionCard.onclick = () => {
                        const audioId = hangulToAudioId[optionText];
                        if (audioId) playAudio(audioId);
                        quizStates[quizInfo.id].userAnswer.push({text: optionText, index: index});
                        optionCard.classList.add('hidden');
                        
                        const answerCard = document.createElement('span');
                        if (quizInfo.id === 'quiz-4' || quizInfo.id === 'quiz-5') {
                            answerCard.className = 'order-answer-card p-1.5 sm:p-3 text-base sm:text-2xl';
                        } else {
                            answerCard.className = 'order-answer-card p-2 sm:p-4 text-base sm:text-2xl';
                        }
                        answerCard.textContent = optionText;
                        answerBox.appendChild(answerCard);
                    };
                    optionsContainer.appendChild(optionCard);
                });
            } else if (quizInfo.type === 'keyboard') {
                const state = (quizStates[quizInfo.id] = { hangulComposer: createHangulComposer() });
                const kbdContainer = form.querySelector(`.keyboard-container`);
                const inputSpan = form.querySelector('.quiz-input');
                inputSpan.textContent = '';
                
                const handleKey = (char) => {
                    inputSpan.textContent = state.hangulComposer.process(char);
                };

                createKeyboard(kbdContainer, handleKey, quizInfo.extraKeys);
            } else if (quizInfo.type === 'radio') {
                form.reset();
            }
        };

        const resetQuiz = (quizId) => {
            const form = document.getElementById(quizId);
            if (!form) return;

            const page = form.closest('.page');
            if (page) page.dataset.answered = 'false';

            form.querySelector('.feedback-message').innerHTML = '';
            form.querySelector('button[type=submit]').classList.remove('hidden');
            retryBtn.classList.add('hidden');
            
            // Just update navigation to hide next button
            updateNavigation(currentPageIndex);
            
            const quizInfo = quizzes.find(q => q.id === quizId);
            if (quizInfo.type === 'radio') form.reset();
            else if (quizInfo.type === 'order') {
                initQuiz(quizInfo); 
            } else if (quizInfo.type === 'keyboard') {
                initQuiz(quizInfo);
            }
        };
        
        document.querySelectorAll('.backspace-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const quizId = `quiz-${btn.dataset.quizId}`;
                const state = quizStates[quizId];
                if (state.userAnswer.length > 0) {
                    const lastAnswer = state.userAnswer.pop();
                    const answerBox = document.getElementById(`q${btn.dataset.quizId}-answer-box`);
                    if(answerBox.lastChild) answerBox.removeChild(answerBox.lastChild);
                    const optionButton = document.querySelector(`#q${btn.dataset.quizId}-options .order-option-card[data-option-index='${lastAnswer.index}']`);
                    if(optionButton) optionButton.classList.remove('hidden');
                }
            });
        });

        // 1) Helper function to ignore spaces and punctuation
        const normalize = (str) => str.replace(/[\s,.!?;:"]/g, '');

        quizzes.forEach(quizInfo => {
            const page = document.getElementById(quizInfo.id)?.closest('.page');
            if(page) initQuiz(quizInfo);
            
            const form = document.getElementById(quizInfo.id);
            if (!form) return;

            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                await initAudio();
                
                let isCorrect = false;
                const state = quizStates[quizInfo.id];
                
                if (quizInfo.type === 'radio') {
                    const formData = new FormData(form);
                    const qName = `q${quizInfo.id.match(/\d+/)[0]}`;
                    isCorrect = formData.get(qName) === quizInfo.answer;
                } else if (quizInfo.type === 'order') {
                    const joinedAnswer = state.userAnswer.map(i => i.text).join('');
                    const answerString = Array.isArray(quizInfo.answer) ? quizInfo.answer.join('') : quizInfo.answer;
                    isCorrect = joinedAnswer === answerString;
                } else { // keyboard
                    let finalAnswer = state.hangulComposer.getFinal().trim();
                    form.querySelector('.quiz-input').textContent = finalAnswer;

                    // 2) Apply normalization to ALL keyboard inputs
                    const normalizedFinal = normalize(finalAnswer);
                    const normalizedCorrect = normalize(quizInfo.answer);

                    isCorrect = normalizedFinal === normalizedCorrect;
                }

                const feedbackEl = form.querySelector('.feedback-message');
                form.querySelector('button[type=submit]').classList.add('hidden');

                if (isCorrect) {
                    if (soundsReady) correctSound.triggerAttackRelease('C5', '0.2s');
                    feedbackEl.textContent = 'Correct !';
                    feedbackEl.className = 'feedback-message text-base sm:text-xl text-green-500';
                    form.closest('.page').dataset.answered = 'true';
                    
                    // Correct answer: Show Next, Hide Retry
                    retryBtn.classList.add('hidden');
                    nextBtn.classList.remove('hidden'); // Ensure display is flex/block
                    updateNavigation(currentPageIndex); 
                } else {
                    if (soundsReady) wrongSound.triggerAttackRelease('A#2', '0.2s');
                    feedbackEl.textContent = 'Ce n\'est pas correct.';
                    feedbackEl.className = 'feedback-message text-base sm:text-xl text-red-500';
                    
                    // Incorrect answer: Show Retry, Completely Hide Next (display:none) to allow overlap position
                    retryBtn.classList.remove('hidden');
                    nextBtn.classList.add('hidden'); 
                }
            });
        });
        
        // --- Physical Keyboard Input Handler ---
        // Lists of valid Korean chars to accept from physical keyboard
        const KOREAN_CHARS = new Set([
            '„ÖÇ', '„Öà', '„Ñ∑', '„Ñ±', '„ÖÖ', '„Öõ', '„Öï', '„Öë', '„Öê', '„Öî',
            '„ÖÅ', '„Ñ¥', '„Öá', '„Ñπ', '„Öé', '„Öó', '„Öì', '„Öè', '„Ö£',
            '„Öã', '„Öå', '„Öä', '„Öç', '„Ö†', '„Öú', '„Ö°',
            '„ÖÉ', '„Öâ', '„Ñ∏', '„Ñ≤', '„ÖÜ', '„Öí', '„Öñ'
        ]);

        window.addEventListener('keydown', (e) => {
            const currentPage = pages[currentPageIndex];
            if (!currentPage || !currentPage.classList.contains('active')) return;
            
            const form = currentPage.querySelector('form');
            if (!form || !form.id.startsWith('quiz-')) return;

            const kbdContainer = currentPage.querySelector('.keyboard-container');
            if (!kbdContainer) return;
            
            // Allow default browser actions for some keys
            if (e.ctrlKey || e.metaKey || e.altKey) return;

            const quizIdNum = kbdContainer.dataset.quizId;
            const quizId = `quiz-${quizIdNum}`;
            const state = quizStates[quizId];
            const inputSpan = currentPage.querySelector(`.quiz-input[data-quiz-id='${quizIdNum}']`);

            if (!state || !inputSpan) return;
            
            let char;
            if (e.key === 'Backspace') {
                char = 'backspace';
                e.preventDefault();
            } else if (e.key === ' ' || e.key === ',' || e.key === '.' || e.key === '!' || e.key === '?') {
                char = e.key;
                e.preventDefault();
            } else if (KOREAN_CHARS.has(e.key)) {
                // Only accept if it is a valid Korean jamo
                char = e.key;
                e.preventDefault();
            } else {
                // Ignore other keys (like English QWERTY input)
                return;
            }
            
            if (char) {
                inputSpan.textContent = state.hangulComposer.process(char);
            }
        });

        // --- Initialisation ---
        showPage(currentPageIndex);
        document.body.addEventListener('click', initAudio, { once: true });
        document.body.addEventListener('touchend', initAudio, { once: true });
    });
    </script>
</body>
</html>
